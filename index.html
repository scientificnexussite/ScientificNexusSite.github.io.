<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050507">
    <meta name="description" content="Scientific Nexus Research Terminal - Advanced Physics & Strategy Simulations">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nexus Terminal">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Scientific Nexus | Research Terminal 2.0</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="/manifest.json">

    <style>
        :root { 
            /* --- COLOR PALETTE --- */
            --cyan: #00f2ff; 
            --cyan-glow: rgba(0, 242, 255, 0.4);
            --cyan-dim: rgba(0, 242, 255, 0.1);
            --purple: #bc13fe; 
            --dark: #050507; 
            --panel-bg: rgba(15, 15, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --header-h: 70px;
            --danger: #ff4444;
            --success: #00ff88;
            --gold: #ffd700;
            
            /* --- TYPOGRAPHY --- */
            --font-main: 'Rajdhani', sans-serif;
            --font-mono: 'Share Tech Mono', monospace;
        }
        
        * { 
            box-sizing: border-box; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; -webkit-user-select: none;
        }
        
        input, textarea, .selectable-text { 
            user-select: text !important; 
            -webkit-user-select: text !important; 
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: var(--dark);
            color: #e0e0e0; 
            font-family: var(--font-main); 
            overscroll-behavior-y: none; 
            -webkit-overflow-scrolling: touch; 
        }

        /* --- PARALLAX BACKGROUND (PRESERVED) --- */
        #fixed-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-image: 
                radial-gradient(circle at 50% 0%, #1a1a2e 0%, transparent 70%),
                linear-gradient(0deg, rgba(0,0,0,0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.2) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            z-index: -10;
            transform: translateZ(0);
            pointer-events: none;
            will-change: transform; /* Optimization D */
        }

        /* --- CRT OVERLAY --- */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
            background-size: 100% 4px;
            pointer-events: none; z-index: 9000;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            animation: scanlineScroll 10s linear infinite;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.6);
        }
        @keyframes scanlineScroll { 
            0% { background-position: 0 0; } 
            100% { background-position: 0 100%; } 
        }

        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s; pointer-events: all;
            will-change: opacity;
        }
        #loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .spinner {
            width: 60px; height: 60px; 
            border: 2px solid var(--cyan-dim); 
            border-top: 2px solid var(--cyan); 
            border-radius: 50%; 
            animation: spin 0.8s cubic-bezier(0.4, 0.0, 0.2, 1) infinite;
            box-shadow: 0 0 15px var(--cyan-dim);
            will-change: transform;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- TOASTS --- */
        #nexus-toast-container {
            position: fixed; top: 90px; right: 20px; z-index: 7000;
            display: flex; flex-direction: column; gap: 12px; pointer-events: none;
            width: auto; max-width: 90vw;
        }
        .nexus-toast {
            background: rgba(10, 15, 20, 0.95);
            border: 1px solid var(--glass-border);
            border-left: 4px solid var(--cyan);
            padding: 15px; width: 320px; max-width: 100%;
            border-radius: 4px; pointer-events: auto;
            transform: translate3d(120%, 0, 0); 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: start; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .nexus-toast.active { transform: translate3d(0, 0, 0); }
        .nt-icon { color: var(--cyan); font-size: 1.2rem; margin-top: 2px; }
        .nt-content h4 { margin: 0 0 5px; font-size: 0.9rem; color: #fff; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 1px; }
        .nt-content p { margin: 0; font-size: 0.85rem; color: #aaa; line-height: 1.4; }

        /* --- NAVIGATION --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5%; 
            background: rgba(5, 5, 7, 0.9); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            position: fixed; width: 100%; top: 0; z-index: 1000; 
            border-bottom: 1px solid var(--glass-border);
            height: var(--header-h); transition: height 0.3s ease;
            box-shadow: 0 4px 30px rgba(0,0,0,0.3);
            transform: translateZ(0); 
        }
        .logo { 
            font-family: var(--font-mono); font-weight: 700; color: var(--cyan); 
            letter-spacing: 2px; font-size: clamp(1rem, 4vw, 1.2rem); 
            text-transform: uppercase; display: flex; align-items: center; gap: 12px; cursor: pointer;
            text-shadow: 0 0 15px var(--cyan-glow);
        }
        .user-nav { display: flex; align-items: center; gap: 15px; }
        .auth-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); color: var(--cyan);
            padding: 8px 18px; border-radius: 2px; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 10px; font-family: var(--font-mono);
            font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap;
        }
        .auth-btn:hover { 
            border-color: var(--cyan); background: var(--cyan-dim); 
            box-shadow: 0 0 15px var(--cyan-dim);
        }
        .user-avatar { width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--cyan); object-fit: cover; }

        #app-content { 
            padding-top: var(--header-h); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding-bottom: 80px; 
            position: relative;
            z-index: 1;
            /* Physics Optimization */
            will-change: transform;
        }

        .hero {
            padding: clamp(60px, 10vh, 100px) 20px 40px; text-align: center;
            border-bottom: 1px solid var(--glass-border);
            position: relative;
        }
        .hero h1 {
            font-family: var(--font-mono);
            font-size: clamp(1.8rem, 6vw, 3.5rem); 
            margin: 0 0 15px;
            color: white; text-transform: uppercase; letter-spacing: 4px;
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .hero p { 
            color: var(--cyan); font-size: clamp(0.9rem, 3vw, 1.1rem); 
            letter-spacing: 2px; text-transform: uppercase; opacity: 0.9; 
            font-family: var(--font-mono);
        }
        
        #install-pwa-btn {
            display: none;
            margin: 20px auto 0;
            background: var(--cyan); color: #000; font-weight: bold; border: none;
        }

        /* --- TERMINAL TABS (NEW FEATURE B) --- */
        .terminal-tabs {
            display: flex; justify-content: center; gap: 5px;
            padding: 0 15px; margin-top: 20px; flex-wrap: wrap;
        }
        .term-tab {
            background: rgba(0,0,0,0.5); border: 1px solid #333; color: #666;
            padding: 10px 20px; font-family: var(--font-mono); text-transform: uppercase;
            letter-spacing: 1px; font-size: 0.8rem; cursor: pointer; transition: 0.3s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .term-tab:hover { color: white; border-color: #666; }
        .term-tab.active {
            background: var(--cyan-dim); color: var(--cyan); border-color: var(--cyan);
            box-shadow: 0 0 15px var(--cyan-dim);
        }

        .ad-uplink-container {
            width: min(95%, 1400px); 
            margin: 30px auto 10px; padding: 2px;
            background: repeating-linear-gradient(45deg, rgba(0,0,0,0), rgba(0,0,0,0) 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px);
            border: 1px dashed var(--glass-border);
            text-align: center; border-radius: 4px; overflow: hidden;
        }
        .ad-label { font-size: 0.6rem; color: #555; text-transform: uppercase; font-family: var(--font-mono); letter-spacing: 2px; margin: 8px 0; display: block; }

        /* --- CONTROLS --- */
        .controls { 
            width: min(100%, 1400px); 
            margin: 20px auto; 
            padding: 0 clamp(10px, 3vw, 20px); 
        }
        
        .search-bar {
            background: var(--panel-bg); 
            border: 1px solid var(--glass-border); 
            border-radius: 4px;
            padding: 0 20px; 
            display: flex; align-items: center; gap: 15px; margin-bottom: 30px;
            transition: all 0.3s; height: 60px; position: relative; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transform: translateZ(0);
        }
        .search-bar:focus-within { border-color: var(--cyan); box-shadow: 0 0 20px var(--cyan-dim); }
        .search-bar i { color: #666; transition: color 0.3s; }
        .search-bar:focus-within i { color: var(--cyan); }
        .search-bar input { 
            background: transparent; border: none; color: white; width: 100%; height: 100%;
            font-size: 1.1rem; font-family: var(--font-main); letter-spacing: 1px; z-index: 2; 
        }
        
        .categories { 
            display: flex; gap: 15px; overflow-x: auto; padding: 5px 5px 20px; 
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .categories::-webkit-scrollbar { display: none; }
        
        .cat-btn {
            background: rgba(255,255,255,0.03); color: #888; border: 1px solid var(--glass-border); 
            padding: 10px 24px; border-radius: 2px;
            white-space: nowrap; cursor: pointer; font-size: 0.9rem; font-family: var(--font-mono);
            text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s;
            flex-shrink: 0;
        }
        .cat-btn.active { 
            background: var(--cyan-dim); color: var(--cyan); border-color: var(--cyan); 
            box-shadow: 0 0 15px var(--cyan-dim);
        }

        /* --- GRID & VIRTUALIZATION --- */
        .grid { 
            display: grid; 
            gap: 20px; 
            padding: 0 20px 40px; 
            max-width: 1400px; 
            margin: 0 auto;
            /* Fluid Grid: Responsive */
            grid-template-columns: repeat(auto-fill, minmax(clamp(150px, 45vw, 240px), 1fr)); 
            width: 100%;
            min-height: 50vh;
        }

        /* Card Skeleton for Lazy Loading */
        .card { 
            background: var(--panel-bg); 
            border: 1px solid var(--glass-border); border-radius: 6px; overflow: hidden;
            position: relative; cursor: pointer; 
            transition: border-color 0.3s, transform 0.2s;
            display: flex; flex-direction: column;
            aspect-ratio: 16/10; /* Fixed aspect ratio to prevent layout shifts */
            transform: translateZ(0);
        }
        
        .card.skeleton {
            background: linear-gradient(90deg, #111 25%, #1a1a1a 50%, #111 75%);
            background-size: 200% 100%;
            animation: loadingSwipe 1.5s infinite;
        }
        @keyframes loadingSwipe { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Content Virtualization: Only render inner when visible */
        .card-content {
            opacity: 0; transition: opacity 0.5s ease;
            width: 100%; height: 100%; display: flex; flex-direction: column;
        }
        .card.visible .card-content { opacity: 1; }

        .thumb { 
            height: 65%; width: 100%; object-fit: cover; opacity: 0.9; 
            background: #000; display: block;
        }
        
        .card-body { 
            padding: 10px 15px; border-top: 1px solid var(--glass-border); 
            flex: 1; display: flex; flex-direction: column; justify-content: center; 
            background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.6) 100%);
        }
        .card-title { 
            margin: 0; font-size: clamp(0.85rem, 1.2vw, 1rem); color: white; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            letter-spacing: 0.5px; font-weight: 600;
        }
        .card-cat { 
            color: var(--cyan); font-size: 0.7rem; margin-top: 5px; 
            display: block; text-transform: uppercase; font-family: var(--font-mono);
        }

        /* --- PAGINATION --- */
        .pagination-container {
            display: flex; justify-content: center; align-items: center; gap: 8px;
            margin: 0 auto 40px; padding: 20px; max-width: 1400px;
        }
        .page-btn {
            background: rgba(10, 15, 20, 0.6); border: 1px solid var(--glass-border); color: #666;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            font-family: var(--font-mono); font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        }
        .page-btn.active { border-color: var(--cyan); color: var(--cyan); background: var(--cyan-dim); }

        /* --- GAME VIEWER --- */
        #game-viewer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 5000; 
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            display: none; opacity: 0; transition: opacity 0.4s ease;
        }
        #game-viewer.active { opacity: 1; }

        .gv-nav {
            height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            border-bottom: 1px solid var(--glass-border); background: rgba(10,10,15,0.95);
            position: sticky; top: 0; z-index: 5001; 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .back-btn { 
            background: transparent; border: 1px solid var(--danger); color: var(--danger); 
            padding: 6px 14px; border-radius: 2px; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem; 
            text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-mono);
        }
        
        .gv-stage { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .game-frame-wrapper {
            position: relative; width: 100%; padding-top: 56.25%; /* 16:9 */
            background: black; border: 1px solid #333; overflow: hidden;
        }
        .game-loader-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #050507; display: flex; align-items: center; justify-content: center; z-index: 5;
        }
        .game-frame-wrapper iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; z-index: 10;
        }
        .game-meta { 
            margin-top: 25px; background: var(--panel-bg); padding: 25px; 
            border: 1px solid var(--glass-border); border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
        }

        /* --- HEAVY COMPUTE BOOST MODE --- */
        body.boost-mode .crt-overlay { display: none; }
        body.boost-mode #fixed-bg { display: none; }
        body.boost-mode * { 
            text-shadow: none !important; 
            box-shadow: none !important; 
            transition: none !important;
            animation: none !important;
        }

        /* --- MOBILE OPTIMIZATION --- */
        @media screen and (max-width: 768px) {
            nav { padding: 0 15px; }
            .grid { 
                /* Mobile optimized grid */
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
                gap: 15px;
            }
            .card { aspect-ratio: 1/1; } /* Square cards for mobile */
            /* Physics fix for mobile scrolling */
            #fixed-bg { display: none; background: #0b0b10; } /* Remove parallax on mobile for 60fps */
            .gv-stage { padding: 0; margin: 0; width: 100%; }
            .game-frame-wrapper { border: none; }
            .modal-box { padding: 0; width: 100%; max-height: 100%; border-radius: 0; }
        }

        /* --- MODALS (PRESERVED) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.active { display: flex; opacity: 1; }
        .modal-box { 
            background: #0a0b10; padding: 35px; border-radius: 8px; border: 1px solid var(--glass-border); 
            width: 100%; max-width: 450px; text-align: center; position: relative;
            max-height: 90vh; overflow-y: auto;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; color: #666; cursor: pointer; font-size: 1.5rem; }
        
        /* Dossier Styles (Preserved) */
        .dossier-container { display: flex; flex-direction: row; min-height: 400px; }
        .dossier-left { width: 220px; background: rgba(0,0,0,0.3); padding: 20px; display: flex; flex-direction: column; align-items: center; border-right: 1px solid #333; }
        .dossier-photo-frame { width: 100px; height: 100px; border: 2px solid var(--cyan); padding: 5px; margin-bottom: 15px; }
        .dossier-photo-frame img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(0.5); }
        .dossier-right { flex: 1; padding: 20px; text-align: left; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .data-cell { background: rgba(255,255,255,0.03); padding: 8px; border-left: 2px solid var(--cyan-dim); }
        .data-label { font-size: 0.6rem; color: #666; font-family: var(--font-mono); display: block; }
        
        @media screen and (max-width: 600px) {
            .dossier-container { flex-direction: column; }
            .dossier-left { width: 100%; flex-direction: row; border-right: none; border-bottom: 1px solid #333; gap: 20px; }
            .dossier-photo-frame { width: 70px; height: 70px; margin-bottom: 0; }
        }

        /* --- SOCIAL FAB & CHAT --- */
        #social-fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; background: rgba(10,10,15,0.9); 
            border: 1px solid var(--cyan); border-radius: 50%; 
            display: none; align-items: center; justify-content: center;
            color: var(--cyan); font-size: 1.5rem; cursor: pointer; z-index: 4000;
        }
        .fab-badge {
            position: absolute; top: -2px; right: -2px; background: var(--danger); color: white;
            width: 22px; height: 22px; border-radius: 50%; font-size: 0.75rem; 
            display: none; align-items: center; justify-content: center; font-weight: bold;
        }
        #social-panel {
            position: fixed; bottom: 110px; right: 30px; width: 350px; height: 500px; max-width: 90vw;
            background: #0a0a0e; border: 1px solid var(--glass-border); border-radius: 12px;
            z-index: 3999; transform: translate3d(130%, 0, 0); transition: transform 0.4s;
            display: flex; flex-direction: column; overflow: hidden;
        }
        #social-panel.active { transform: translate3d(0, 0, 0); }
        .social-tabs { display: flex; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; padding: 15px 0; background: none; border: none; color: #666; cursor: pointer; font-family: var(--font-mono); font-size: 0.75rem; }
        .tab-btn.active { color: var(--cyan); border-bottom: 2px solid var(--cyan); }
        .social-body { flex: 1; overflow-y: auto; position: relative; }
        .social-view { display: none; padding: 10px; }
        .social-view.active { display: block; }

        /* Chat Interface */
        #chat-interface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b0b10; z-index: 50; display: flex; flex-direction: column;
            transform: translate3d(100%, 0, 0); transition: 0.3s;
        }
        #chat-interface.open { transform: translate3d(0, 0, 0); }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; }
        .msg.mine { align-self: flex-end; background: var(--cyan); color: black; }
        .msg.theirs { align-self: flex-start; background: #222; color: white; }

        .footer-terminal {
            text-align: center; padding: 30px; margin-top: 50px;
            border-top: 1px solid var(--glass-border); font-size: 0.8rem; color: #555;
            font-family: var(--font-mono);
        }
    </style>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6504872858297214" crossorigin="anonymous"></script>
</head>
<body>

<div id="fixed-bg"></div>
<div class="crt-overlay"></div>
<div id="loader"><div class="spinner"></div></div>
<div id="nexus-toast-container"></div>

<nav>
    <div class="logo" onclick="goHome()">
        <i class="fas fa-atom fa-spin-pulse" style="--fa-animation-duration: 3s;"></i>
        <span>SCIENTIFIC NEXUS</span>
    </div>
    <div class="user-nav" id="auth-container">
        <span style="font-size:0.75rem; color:#666; font-family:var(--font-mono);">INITIALIZING UPLINK...</span>
    </div>
</nav>

<div id="app-content">
    <div class="hero">
        <h1>Research Terminal</h1>
        <p>Advanced Tactical Simulations & Physics Modules</p>
        <button id="install-pwa-btn" class="auth-btn">
            <i class="fas fa-download"></i> Install Terminal App
        </button>
    </div>

    <div class="terminal-tabs">
        <div class="term-tab active" onclick="switchTerminalMode('arcade')">HTML5 ARCADE</div>
        <div class="term-tab" onclick="switchTerminalMode('compute')">HEAVY COMPUTE</div>
        <div class="term-tab" onclick="switchTerminalMode('emulation')">EMULATION CORE</div>
    </div>

    <div class="ad-uplink-container">
        <span class="ad-label">Sponsored Uplink Protocol // AD-NET</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6504872858297214"
             data-ad-slot="5786114760"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div class="controls">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="SEARCH DATABASE..." onkeyup="filterGames()">
        </div>
        
        <div class="categories">
            <button class="cat-btn active" onclick="filterCat('All')">All</button>
            <button class="cat-btn" onclick="filterCat('Action')">Action</button>
            <button class="cat-btn" onclick="filterCat('Strategy')">Strategy</button>
            <button class="cat-btn" onclick="filterCat('Physics')">Physics</button>
            <button class="cat-btn" onclick="filterCat('Puzzle')">Puzzle</button>
            <button class="cat-btn" onclick="filterCat('Simulation')">Simulation</button>
            <button class="cat-btn" onclick="filterCat('Arcade')">Arcade</button>
            <button class="cat-btn" onclick="filterCat('Sports & Racing')">Sports & Racing</button>
        </div>
    </div>

    <div class="grid" id="game-grid"></div>
    <div id="pagination-controls" class="pagination-container"></div>
    
    <div class="footer-terminal">
        <div style="margin-bottom: 15px; font-weight:bold;">SCIENTIFIC NEXUS TERMINAL v2.0 // EST. 2024</div>
        <span style="cursor: pointer; color:#777;" onclick="openProtocols()">NEXUS PROTOCOLS</span>
    </div>
</div>

<div id="game-viewer">
    <div class="gv-nav">
        <div style="display:flex; align-items:center; gap:15px;">
             <button class="back-btn" onclick="closeGame()">
                <i class="fas fa-times"></i> <span>Terminate</span>
            </button>
            <span id="gv-title" style="font-weight:bold; color:white; font-family:var(--font-mono); font-size:0.9rem;">SIMULATION</span>
        </div>
        <button class="auth-btn" onclick="toggleFull()" style="border-color:#333; color:#aaa;"><i class="fas fa-expand"></i></button>
    </div>
    <div class="gv-stage">
        <div class="game-frame-wrapper" id="gf-wrapper">
            <div class="game-loader-overlay" id="game-loader-ui">
                <div class="spinner"></div>
                <div id="emu-msg" style="display:none; text-align:center; margin-top:80px; font-family:var(--font-mono); color:var(--cyan);">
                    MOUNTING BIOS...<br>SELECT ROM FILE
                </div>
            </div>
            <iframe id="game-frame" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-pointer-lock" allowfullscreen></iframe>
        </div>
        <div class="game-meta">
            <div>
                <span style="color:#666; font-size:0.75rem; text-transform:uppercase; display:block;">Module</span>
                <span id="gv-cat" style="color:var(--cyan); font-weight:bold; font-family:var(--font-mono);">Physics</span>
            </div>
        </div>
    </div>
</div>

<div id="social-fab" onclick="toggleSocialPanel()">
    <i class="fas fa-users"></i>
    <div class="fab-badge" id="global-badge">0</div>
</div>

<div id="social-panel">
    <div id="chat-interface">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <span id="chat-friend-name" style="color:var(--cyan); font-family:var(--font-mono);">UNKNOWN</span>
            <button onclick="closeChat()" style="background:none; border:none; color:white;"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-messages" id="chat-msgs"></div>
        <div style="padding:10px; border-top:1px solid #333; display:flex;">
            <input type="text" id="chat-input" placeholder="Message..." onkeypress="handleChatKey(event)" style="flex:1; background:#111; border:1px solid #333; color:white; padding:8px;">
            <button onclick="sendMessage()" style="background:var(--cyan); border:none; width:40px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="social-tabs">
        <button class="tab-btn active" onclick="switchTab('friends')">ALLIES</button>
        <button class="tab-btn" onclick="switchTab('ranking')">RANK</button>
        <button class="tab-btn" onclick="switchTab('comms')">COMMS</button>
    </div>

    <div class="social-body">
        <div id="view-friends" class="social-view active">
            <div id="friends-list"></div>
        </div>
        <div id="view-ranking" class="social-view"><div id="leaderboard-list"></div></div>
        <div id="view-comms" class="social-view">
            <div style="padding:10px; text-align:center;">
                <input type="text" id="invite-input-tab" placeholder="ENTER CMDR ID" style="background:#111; border:1px solid #333; color:var(--cyan); padding:10px; width:80%; text-align:center; font-family:var(--font-mono);">
                <button onclick="sendInvite()" style="margin-top:10px; background:var(--cyan); border:none; padding:8px 20px; font-weight:bold;">LINK</button>
                <p id="invite-msg-tab" style="font-size:0.7rem; color:#aaa; margin-top:10px;"></p>
                <div id="requests-list" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="login-modal" class="modal">
    <div class="modal-box">
        <span class="close-modal" onclick="closeModal('login-modal')">×</span>
        <h2 style="color:white; margin-top:0; font-family:var(--font-mono);">IDENTITY REQUIRED</h2>
        <button onclick="loginGoogle()" style="background:white; color:black; border:none; padding:12px; width:100%; border-radius:4px; font-weight:bold; margin-top:20px;">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
    </div>
</div>

<div id="username-modal" class="modal" style="z-index: 6001;">
    <div class="modal-box">
        <h2 style="color:var(--cyan); margin-top:0; font-family:var(--font-mono);">CREATE ALIAS</h2>
        <input type="text" id="new-username" placeholder="CODENAME (3-10 CHARS)" style="width:100%; padding:10px; background:#111; border:1px solid var(--cyan); color:white; text-align:center;">
        <p id="username-error" style="color:var(--danger); display:none; font-size:0.8rem;"></p>
        <button onclick="submitUsername()" style="background:var(--cyan); width:100%; padding:10px; border:none; margin-top:15px; font-weight:bold;">ESTABLISH ID</button>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-box" style="max-width:700px; padding:0; overflow:hidden;">
        <span class="close-modal" onclick="closeModal('profile-modal')" style="z-index:100; color:white;">×</span>
        <div id="profile-content"></div>
    </div>
</div>

<div id="protocols-modal" class="modal">
    <div class="modal-box">
        <span class="close-modal" onclick="closeModal('protocols-modal')">×</span>
        <h2 style="color:var(--cyan); margin-top:0; font-family:var(--font-mono);">NEXUS PROTOCOLS</h2>
        <div style="text-align:left; font-size:0.85rem; color:#ccc; height:300px; overflow-y:auto;">
            <p><strong>1.0 DIRECTIVE:</strong> The Scientific Nexus Research Terminal (SNRT) aggregates high-fidelity simulations.</p>
            <p><strong>2.0 DATA PRIVACY:</strong> We use Firebase Authentication. No passwords stored locally.</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, where, orderBy, limit, serverTimestamp, writeBatch, collectionGroup, setDoc, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG & INIT ---
    const firebaseConfig = {
        apiKey: "AIzaSyCrgwoD_IVwlyvUQwDDQj6T772obSOL8So",
        authDomain: "scientificnexus-65c48.firebaseapp.com",
        projectId: "scientificnexus-65c48",
        storageBucket: "scientificnexus-65c48.firebasestorage.app",
        messagingSenderId: "125907587809",
        appId: "1:125907587809:web:d8068604db659fa357dda0",
        measurementId: "G-787GN5V4WT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- STATE MANAGEMENT ---
    let currentUser = null;
    let userData = null;
    let activeChatId = null;
    let currentChatUserUid = null;
    let chatUnsub = null;
    
    // UI State
    let currentMode = 'arcade'; // arcade, compute, emulation
    let currentPage = 1;
    const itemsPerPage = 12; // Balanced for grid
    let currentFilteredGames = [];

    // --- GAME DATABASE (ALL PRESERVED) ---
    const arcadeGames = [
       { title: "SkillFull Finger", cat: "Physics", url: "https://html5.gamedistribution.com/c7af7f58929a4a3c891ccf1192223a6a/", thumb: "https://img.gamedistribution.com/c7af7f58929a4a3c891ccf1192223a6a-1280x720.jpg" },
       { title: "Football Duel", cat: "Sports & Racing", url: "https://html5.gamedistribution.com/4a9c7ad53f7c48678b3b848390a62daa/", thumb: "https://img.gamedistribution.com/4a9c7ad53f7c48678b3b848390a62daa-1280x720.jpg" },
       { title: "Tap it Away 3D", cat: "Puzzle", url: "https://html5.gamedistribution.com/87cb43c5492049b49b01491248d9ced1/", thumb: "https://img.gamedistribution.com/87cb43c5492049b49b01491248d9ced1-1280x720.jpg" },
       { title: "Zombie Survival", cat: "Action", url: "https://html5.gamedistribution.com/53ad84c4f3b440f2b65d5382fadf731f/", thumb: "https://img.gamedistribution.com/53ad84c4f3b440f2b65d5382fadf731f-1280x720.jpg" },
       { title: "Bar Brawl", cat: "Action", url: "https://html5.gamedistribution.com/f3a9542e779b426799867918b11fd70b/", thumb: "https://img.gamedistribution.com/f3a9542e779b426799867918b11fd70b-1280x720.jpg" },
       { title: "Stick Master", cat: "Strategy", url: "https://html5.gamedistribution.com/a497f71f7ff64128bb9f3d4f7a58dddc/", thumb: "https://img.gamedistribution.com/a497f71f7ff64128bb9f3d4f7a58dddc-512x384.jpg" },
       { title: "Craft Of Wars", cat: "Arcade", url: "https://html5.gamedistribution.com/99b5f30d028d40df825363d98fa5831f/", thumb: "https://img.gamedistribution.com/99b5f30d028d40df825363d98fa5831f-512x512.jpg" },
       { title: "Coe Snake", cat: "Casual", url: "https://html5.gamedistribution.com/b73efc1f47194a4cbb5d0af8b492187b/", thumb: "https://img.gamedistribution.com/b73efc1f47194a4cbb5d0af8b492187b-1280x720.jpg" },
       { title: "Real Cargo Truck", cat: "Simulation", url: "https://html5.gamedistribution.com/1ea2160082d542ce8d9166f63f61d366/", thumb: "https://img.gamedistribution.com/1ea2160082d542ce8d9166f63f61d366-512x384.jpg" },
       { title: "Math vs Bat", cat: "Educational", url: "https://html5.gamedistribution.com/91c70ab32b754af89cd73528ba236d34/", thumb: "https://img.gamedistribution.com/91c70ab32b754af89cd73528ba236d34-512x384.jpeg" },
       { title: "Drift Boss", cat: "Sports & Racing", url: "https://html5.gamedistribution.com/0a8b51e5eaee42e7b4db83ca00afc92e/", thumb: "https://img.gamedistribution.com/0a8b51e5eaee42e7b4db83ca00afc92e-512x384.jpg" },
       { title: "Daily Solitaire", cat: "Casual", url: "https://html5.gamedistribution.com/5e6d0ffd732a496bb5f0dc2a15e88778/", thumb: "https://img.gamedistribution.com/5e6d0ffd732a496bb5f0dc2a15e88778-1280x550.jpeg" },
       { title: "Airport Security", cat: "Casual", url: "https://html5.gamedistribution.com/aff91273917349db8ae9a921954aae5c/", thumb: "https://img.gamedistribution.com/aff91273917349db8ae9a921954aae5c-1280x720.jpg" },
       { title: "Police Traffic Racer", cat: "Sports & Racing", url: "https://html5.gamedistribution.com/8748f54767044b99bc5373fc61596123/", thumb: "https://img.gamedistribution.com/8748f54767044b99bc5373fc61596123-1280x720.jpg" },
       { title: "Gas Station", cat: "Casual", url: "https://html5.gamedistribution.com/53f75279264b4a6484601a99be7aef87/", thumb: "https://img.gamedistribution.com/53f75279264b4a6484601a99be7aef87-1280x720.jpg" },
       { title: "Wood Block Puzzle 3", cat: "Puzzle", url: "https://html5.gamedistribution.com/a00735b23bde40798cfc095745212754/", thumb: "https://img.gamedistribution.com/a00735b23bde40798cfc095745212754-512x384.jpg" },
       { title: "Color Block Blast 3", cat: "Puzzle", url: "https://html5.gamedistribution.com/003becedcaf14456879312d685937e17/", thumb: "https://img.gamedistribution.com/003becedcaf14456879312d685937e17-1280x720.jpg" },
       { title: "Hook Pin Jam", cat: "Puzzle", url: "https://html5.gamedistribution.com/b1b399e2218a45a8b7550b8e91347ae3/", thumb: "https://img.gamedistribution.com/b1b399e2218a45a8b7550b8e91347ae3-1280x720.jpg" },
       { title: "Jixora", cat: "Puzzle", url: "https://html5.gamedistribution.com/c22dd33f66654986bf42e494c5934308/", thumb: "https://img.gamedistribution.com/c22dd33f66654986bf42e494c5934308-512x384.jpg" },
       { title: "Clean House", cat: "Simulation", url: "https://html5.gamedistribution.com/f2fb3252714f4926a17983feb37a8512/", thumb: "https://img.gamedistribution.com/f2fb3252714f4926a17983feb37a8512-200x120.jpg" },
       { title: "Vex X3M", cat: "Sports & Racing", url: "https://html5.gamedistribution.com/0a3c55fe33ba415f9b761b5831e75b27/", thumb: "https://img.gamedistribution.com/0a3c55fe33ba415f9b761b5831e75b27-1280x550.jpg" },
       { title: "Hexagon", cat: "Puzzle", url: "https://html5.gamedistribution.com/882e8405283041b7922818fa6ff892b6/", thumb: "https://img.gamedistribution.com/882e8405283041b7922818fa6ff892b6-1280x550.jpg" },
       { title: "Fusion 2048", cat: "Puzzle", url: "https://html5.gamedistribution.com/0e5b95715bb34907ae915ad4e985cd50/", thumb: "https://img.gamedistribution.com/0e5b95715bb34907ae915ad4e985cd50-1280x720.jpg" },
       { title: "CUBE KING", cat: "Puzzle", url: "https://html5.gamedistribution.com/2397418fd5a443fc948a60bd7784d7b6/", thumb: "https://img.gamedistribution.com/2397418fd5a443fc948a60bd7784d7b6-200x120.jpg" }
    ];

    const heavyComputeGames = [
        { title: "WebGL Fluid Sim", cat: "Heavy Compute", url: "https://paveldogreat.github.io/WebGL-Fluid-Simulation/", thumb: "https://via.placeholder.com/300x200?text=Fluid+Dynamics" },
        { title: "Gravity Core", cat: "Heavy Compute", url: "about:blank", thumb: "https://via.placeholder.com/300x200?text=Gravity+Sim" }
    ];

    const emulationGames = [
        { title: "PlayStation Core", cat: "Emulation", url: "BIOS_PSX", thumb: "https://via.placeholder.com/300x200?text=PS1+Bios" },
        { title: "PSP Core", cat: "Emulation", url: "BIOS_PSP", thumb: "https://via.placeholder.com/300x200?text=PSP+Engine" }
    ];

    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
        const loader = document.getElementById('loader');
        if(loader) loader.classList.add('hidden');
        
        currentFilteredGames = arcadeGames; // Default
        render();
        setupPWA();
    });

    // --- CONTENT VIRTUALIZATION (A) ---
    function render() {
        const grid = document.getElementById('game-grid');
        grid.innerHTML = '';
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const gamesToShow = currentFilteredGames.slice(startIndex, endIndex);

        gamesToShow.forEach(g => {
            // Create "Skeleton" Card (Empty shell)
            const shell = document.createElement('div');
            shell.className = 'card skeleton';
            shell.dataset.title = g.title;
            shell.dataset.cat = g.cat;
            shell.dataset.thumb = g.thumb;
            shell.dataset.url = g.url;
            
            shell.onclick = () => openGame(g.url, g.title, g.cat);
            grid.appendChild(shell);
        });

        renderPagination();
        attachObserver(); // Start watching for visibility
    }

    function attachObserver() {
        const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const card = entry.target;
                    loadCardContent(card);
                    obs.unobserve(card); // Stop watching once loaded
                }
            });
        }, { rootMargin: "100px" });

        document.querySelectorAll('.card.skeleton').forEach(c => observer.observe(c));
    }

    function loadCardContent(card) {
        const { title, cat, thumb } = card.dataset;
        
        card.innerHTML = `
            <div class="card-content">
                <img src="${thumb}" class="thumb" alt="${title}" loading="lazy">
                <div class="card-body">
                    <h3 class="card-title">${title}</h3>
                    <span class="card-cat">${cat}</span>
                </div>
            </div>
        `;
        
        const img = card.querySelector('img');
        img.onload = () => {
            card.classList.remove('skeleton');
            card.classList.add('visible');
        };
        if(img.complete) {
            card.classList.remove('skeleton');
            card.classList.add('visible');
        }
    }

    function renderPagination() {
        const container = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(currentFilteredGames.length / itemsPerPage);
        
        if (totalPages <= 1) { container.innerHTML = ''; return; }
        
        let html = ``;
        if (currentPage > 1) html += `<div class="page-btn" onclick="changePage(${currentPage - 1})"><i class="fas fa-chevron-left"></i></div>`;
        html += `<div class="page-btn active">${currentPage}</div>`;
        if (currentPage < totalPages) html += `<div class="page-btn" onclick="changePage(${currentPage + 1})"><i class="fas fa-chevron-right"></i></div>`;
        
        container.innerHTML = html;
    }

    window.changePage = function(p) {
        currentPage = p;
        render();
        document.querySelector('.controls').scrollIntoView({behavior:'smooth'});
    };

    // --- TERMINAL TAB LOGIC (B) ---
    window.switchTerminalMode = function(mode) {
        currentMode = mode;
        currentPage = 1;

        // Update Tabs UI
        const tabs = document.querySelectorAll('.term-tab');
        tabs.forEach(t => t.classList.remove('active'));
        if(mode === 'arcade') tabs[0].classList.add('active');
        if(mode === 'compute') tabs[1].classList.add('active');
        if(mode === 'emulation') tabs[2].classList.add('active');

        // Logic
        if (mode === 'arcade') {
            document.body.classList.remove('boost-mode');
            currentFilteredGames = arcadeGames;
        } else if (mode === 'compute') {
            document.body.classList.add('boost-mode'); // Disable animations
            currentFilteredGames = heavyComputeGames;
            showToast('fas fa-microchip', 'BOOST MODE', 'Animations disabled for max performance.');
        } else if (mode === 'emulation') {
            document.body.classList.remove('boost-mode');
            currentFilteredGames = emulationGames;
        }
        
        render();
    };

    window.filterCat = function(cat) {
        let source = currentMode === 'arcade' ? arcadeGames : (currentMode === 'compute' ? heavyComputeGames : emulationGames);
        currentFilteredGames = (cat === 'All' ? source : source.filter(g => g.cat.includes(cat)));
        currentPage = 1;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        render();
    };

    window.filterGames = function() {
        const q = document.getElementById('search-input').value.toLowerCase();
        let source = currentMode === 'arcade' ? arcadeGames : (currentMode === 'compute' ? heavyComputeGames : emulationGames);
        currentFilteredGames = source.filter(g => g.title.toLowerCase().includes(q));
        currentPage = 1;
        render();
    };

    // --- GAME LAUNCHER & EMULATION ---
    window.openGame = function(url, title, cat) {
        const gv = document.getElementById('game-viewer');
        const loader = document.getElementById('game-loader-ui');
        const frame = document.getElementById('game-frame');
        const emuMsg = document.getElementById('emu-msg');

        gv.style.display = 'block';
        setTimeout(() => gv.classList.add('active'), 10);
        loader.style.display = 'flex';
        emuMsg.style.display = 'none';

        if (cat === 'Emulation') {
            frame.src = ''; 
            emuMsg.style.display = 'block';
            document.getElementById('gv-title').innerText = title;
            document.getElementById('gv-cat').innerText = "EMULATION CORE";
            return;
        }

        frame.src = url;
        frame.onload = () => { loader.style.display = 'none'; };
        
        document.getElementById('gv-title').innerText = title;
        document.getElementById('gv-cat').innerText = cat;
    };

    window.closeGame = function() {
        const gv = document.getElementById('game-viewer');
        gv.classList.remove('active');
        setTimeout(() => {
            gv.style.display = 'none';
            document.getElementById('game-frame').src = 'about:blank';
        }, 400);
    };

    window.toggleFull = function() {
        const el = document.getElementById('gf-wrapper');
        !document.fullscreenElement ? el.requestFullscreen().catch(e=>{}) : document.exitFullscreen();
    };

    // --- PWA LOGIC (C) ---
    let deferredPrompt;
    function setupPWA() {
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('install-pwa-btn');
            btn.style.display = 'flex';
            
            btn.addEventListener('click', () => {
                btn.style.display = 'none';
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choice) => {
                    if (choice.outcome === 'accepted') {
                        console.log('User accepted PWA install');
                    }
                    deferredPrompt = null;
                });
            });
        });
    }

    // --- GLOBAL UTILS ---
    window.goHome = function() { window.scrollTo({ top: 0, behavior: 'smooth' }); };
    window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); };
    window.openProtocols = function() { document.getElementById('protocols-modal').classList.add('active'); };

    function showToast(icon, title, msg) {
        const c = document.getElementById('nexus-toast-container');
        const t = document.createElement('div');
        t.className = 'nexus-toast';
        t.innerHTML = `<i class="${icon} nt-icon"></i><div class="nt-content"><h4>${title}</h4><p>${msg}</p></div>`;
        c.appendChild(t);
        setTimeout(() => t.classList.add('active'), 50);
        setTimeout(() => { t.classList.remove('active'); setTimeout(() => t.remove(), 500); }, 3000);
    }

    // --- FIREBASE AUTH & SOCIAL ---
    window.openLoginModal = function() { document.getElementById('login-modal').classList.add('active'); };
    window.loginGoogle = function() {
        signInWithPopup(auth, new GoogleAuthProvider()).then(() => window.closeModal('login-modal')).catch(alert);
    };

    onAuthStateChanged(auth, user => {
        currentUser = user;
        const nav = document.getElementById('auth-container');
        if (user) {
            onSnapshot(doc(db, 'users', user.uid), snap => {
                if(snap.exists()) {
                    userData = snap.data();
                    if(!userData.username) document.getElementById('username-modal').classList.add('active');
                    else {
                        ensureCommanderId();
                        nav.innerHTML = `<button class="auth-btn" style="border-color:var(--cyan);" onclick="openProfileModal()"><img src="${user.photoURL}" class="user-avatar"><span>${userData.username}</span></button>`;
                        document.getElementById('social-fab').style.display = 'flex';
                        loadSocialData();
                    }
                } else document.getElementById('username-modal').classList.add('active');
            });
        } else {
            nav.innerHTML = `<button class="auth-btn" onclick="openLoginModal()">ACCESS</button>`;
            document.getElementById('social-fab').style.display = 'none';
        }
    });

    window.openProfileModal = function() {
        if(!userData) return;
        const xp = calculateXP(userData.joined);
        const html = `
            <div class="dossier-container">
                <div class="dossier-left">
                    <div class="dossier-photo-frame"><img src="${currentUser.photoURL}"></div>
                    <div style="font-family:var(--font-mono); color:var(--cyan); border:1px dashed #555; padding:5px; cursor:pointer;" onclick="navigator.clipboard.writeText('${userData.commanderId}')" title="Copy ID">
                        ID: ${userData.commanderId}
                    </div>
                </div>
                <div class="dossier-right">
                    <h2 style="margin:0; color:white; text-transform:uppercase;">${userData.username}</h2>
                    <div style="color:var(--cyan); font-weight:bold; margin-bottom:15px;">LEVEL ${xp.level} OPERATIVE</div>
                    <div class="data-grid">
                        <div class="data-cell"><span class="data-label">STATUS</span><span style="color:var(--success);">ACTIVE</span></div>
                        <div class="data-cell"><span class="data-label">ALLIES</span><span>${userData.friends?.length || 0}</span></div>
                    </div>
                    <div style="margin-top:20px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem;"><span>XP PROGRESS</span><span>${Math.round(xp.percent)}%</span></div>
                        <div style="height:8px; background:#111; border:1px solid #333; margin-top:5px;"><div style="width:${xp.percent}%; height:100%; background:var(--cyan);"></div></div>
                    </div>
                    <button onclick="signOut(auth).then(()=>window.location.reload())" style="margin-top:30px; background:none; border:1px solid var(--danger); color:var(--danger); padding:10px; width:100%;">LOGOUT</button>
                </div>
            </div>`;
        document.getElementById('profile-content').innerHTML = html;
        document.getElementById('profile-modal').classList.add('active');
    };

    function calculateXP(joined) {
        if(!joined) return { level:1, percent:0 };
        const days = Math.floor((Date.now() - (joined.seconds*1000))/(1000*3600*24)) || 1;
        const lvl = Math.floor((days*50)/500)+1;
        return { level: lvl, percent: (((days*50)%500)/500)*100 };
    }

    async function ensureCommanderId() {
        if(userData.commanderId) return;
        const newId = Math.floor(10000000 + Math.random() * 90000000).toString();
        const batch = writeBatch(db);
        batch.set(doc(db, "friend_codes", newId), { uid: currentUser.uid });
        batch.update(doc(db, "users", currentUser.uid), { commanderId: newId });
        await batch.commit();
    }

    window.submitUsername = async function() {
        const u = document.getElementById('new-username').value.trim();
        if(!/^[a-zA-Z0-9]{3,10}$/.test(u)) return;
        const batch = writeBatch(db);
        const cId = Math.floor(Math.random()*100000000).toString();
        batch.set(doc(db, 'users', currentUser.uid), { username: u, commanderId: cId, joined: serverTimestamp(), friends: [], blocked: [] }, {merge:true});
        batch.set(doc(db, 'friend_codes', cId), { uid: currentUser.uid });
        await batch.commit();
        window.location.reload();
    };

    // --- SOCIAL & CHAT ---
    window.toggleSocialPanel = () => document.getElementById('social-panel').classList.toggle('active');
    window.switchTab = (t) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.social-view').forEach(v => v.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${t}`).classList.add('active');
    };

    function loadSocialData() {
        onSnapshot(query(collection(db,'friend_requests'), where('toUid','==',currentUser.uid)), s => {
            let h = ''; s.forEach(d => h += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333;"><span style="color:white;">${d.data().fromName}</span><button onclick="acceptReq('${d.id}','${d.data().fromUid}','${d.data().fromName}')" style="color:var(--success); background:none; border:none;">ACCEPT</button></div>`);
            document.getElementById('requests-list').innerHTML = h || '<div style="text-align:center; color:#555;">No signals</div>';
        });
        if(userData.friends) renderFriends(userData.friends);
    }
    
    function renderFriends(list) {
        const c = document.getElementById('friends-list'); c.innerHTML = '';
        list.forEach(f => {
            const d = document.createElement('div'); d.style = 'display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #222; cursor:pointer;';
            d.innerHTML = `<div style="flex:1; color:white; font-size:0.9rem;">${f.username}</div><i class="far fa-comment" style="color:var(--cyan);"></i>`;
            d.onclick = () => openChat(f.uid, f.username);
            c.appendChild(d);
        });
    }

    window.sendInvite = async () => {
        const code = document.getElementById('invite-input-tab').value.trim();
        const docSnap = await getDoc(doc(db, 'friend_codes', code));
        if(docSnap.exists()) {
            await addDoc(collection(db, 'friend_requests'), { fromUid: currentUser.uid, fromName: userData.username, toUid: docSnap.data().uid });
            document.getElementById('invite-msg-tab').innerText = "SENT";
        } else document.getElementById('invite-msg-tab').innerText = "INVALID ID";
    };

    window.acceptReq = async (id, uid, name) => {
        const batch = writeBatch(db);
        batch.update(doc(db, 'users', currentUser.uid), { friends: arrayUnion({uid, username:name}) });
        batch.update(doc(db, 'users', uid), { friends: arrayUnion({uid:currentUser.uid, username:userData.username}) });
        batch.delete(doc(db, 'friend_requests', id));
        await batch.commit();
    };

    window.openChat = (uid, name) => {
        currentChatUserUid = uid;
        document.getElementById('chat-friend-name').innerText = name;
        document.getElementById('chat-interface').classList.add('open');
        activeChatId = [currentUser.uid, uid].sort().join('_');
        if(chatUnsub) chatUnsub();
        chatUnsub = onSnapshot(query(collection(db,'chats',activeChatId,'messages'), orderBy('timestamp','asc'), limit(50)), s => {
            const div = document.getElementById('chat-msgs'); div.innerHTML='';
            s.forEach(d => { const m=d.data(); div.innerHTML+=`<div class="msg ${m.senderId===currentUser.uid?'mine':'theirs'}">${m.text}</div>`; });
            div.scrollTop=div.scrollHeight;
        });
    };
    
    window.closeChat = () => document.getElementById('chat-interface').classList.remove('open');
    window.sendMessage = async () => {
        const i = document.getElementById('chat-input'); if(!i.value) return;
        await addDoc(collection(db,'chats',activeChatId,'messages'), { text:i.value, senderId:currentUser.uid, receiverId:currentChatUserUid, timestamp:serverTimestamp() });
        i.value='';
    };
    window.handleChatKey = (e) => { if(e.key==='Enter') sendMessage(); };
</script>
</body>
</html>