<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050507">
    <meta name="description" content="Scientific Nexus Research Terminal - Advanced Physics & Strategy Simulations">
    
    <link rel="manifest" href="/manifest.json">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>Scientific Nexus | Research Terminal 2.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- KEEPING ALL EXISTING STYLES AS REQUESTED --- */
        :root { 
            --cyan: #00f2ff; 
            --cyan-dim: rgba(0, 242, 255, 0.1);
            --purple: #bc13fe; 
            --dark: #050507; 
            --panel: #0f0f13;
            --border: rgba(255,255,255,0.08);
            --header-h: 70px;
            --glass: rgba(15, 15, 19, 0.95);
            --danger: #ff4444;
            --success: #00ff88;
            --gold: #ffd700;
        }
        
        * { 
            box-sizing: border-box; outline: none; 
            -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none;
        }
        input, textarea { user-select: text !important; -webkit-user-select: text !important; }

        body { 
            background: var(--dark); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; overflow-x: hidden;
        }

        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 9000;
        }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s; pointer-events: all;
        }
        #loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .spinner {
            width: 50px; height: 50px; border: 3px solid var(--cyan-dim); 
            border-top: 3px solid var(--cyan); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #nexus-toast-container {
            position: fixed; top: 90px; right: 20px; z-index: 7000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .nexus-toast {
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--cyan);
            backdrop-filter: blur(10px);
            padding: 12px 15px; width: 300px;
            border-radius: 4px; pointer-events: auto;
            transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: start; gap: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .nexus-toast.active { transform: translateX(0); }
        .nt-icon { color: var(--cyan); margin-top: 2px; }
        .nt-content h4 { margin: 0 0 3px; font-size: 0.85rem; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
        .nt-content p { margin: 0; font-size: 0.8rem; color: #aaa; line-height: 1.3; }

        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5%; background: rgba(5,5,7,0.9); backdrop-filter: blur(15px);
            position: fixed; width: 100%; top: 0; z-index: 1000; border-bottom: 1px solid var(--border);
            height: var(--header-h);
        }
        .logo { 
            font-weight: 800; color: var(--cyan); letter-spacing: 1.5px; font-size: 1.1rem; 
            text-transform: uppercase; display: flex; align-items: center; gap: 10px; cursor: pointer;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.4);
        }
        .user-nav { display: flex; align-items: center; gap: 15px; }
        .auth-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white;
            padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem; letter-spacing: 1px;
            text-transform: uppercase;
        }
        .auth-btn:hover { border-color: var(--cyan); background: var(--cyan-dim); box-shadow: 0 0 10px var(--cyan-dim); }
        .user-avatar { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--cyan); object-fit: cover; }

        #app-content { padding-top: var(--header-h); min-height: 100vh; }
        
        .reveal-on-scroll {
            opacity: 0; transform: translateY(30px);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .reveal-on-scroll.reveal { opacity: 1; transform: translateY(0); }

        .hero {
            padding: 80px 20px 50px; text-align: center;
            background: radial-gradient(circle at 50% 0%, #1a1a2e 0%, var(--dark) 70%);
            border-bottom: 1px solid var(--border);
        }
        .hero h1 {
            font-size: 2.5rem; margin: 0 0 10px;
            color: white; text-transform: uppercase; letter-spacing: 2px;
        }
        .hero p { color: var(--cyan); font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; opacity: 0.8; }

        .controls { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        
        .search-bar {
            background: var(--panel); border: 1px solid var(--border); border-radius: 4px;
            padding: 12px 15px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
            transition: all 0.3s;
        }
        .search-bar:focus-within { border-color: var(--cyan); box-shadow: 0 0 15px var(--cyan-dim); }
        .search-bar i { color: #666; }
        .search-bar input { background: transparent; border: none; color: white; width: 100%; font-size: 1rem; font-family: inherit; }
        
        .categories { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .cat-btn {
            background: rgba(255,255,255,0.05); color: #888; border: 1px solid var(--border); padding: 8px 20px; 
            border-radius: 4px; white-space: nowrap; cursor: pointer; font-size: 0.8rem; 
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
        }
        .cat-btn:hover, .cat-btn.active { background: var(--cyan); color: black; border-color: var(--cyan); font-weight: bold; }

        .grid { 
            display: grid; gap: 20px; padding: 0 20px 50px; max-width: 1400px; margin: 0 auto;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
        }

        .card { 
            background: var(--panel); border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
            position: relative; cursor: pointer; transition: transform 0.3s, border-color 0.3s;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--cyan); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .thumb { height: 180px; width: 100%; object-fit: cover; opacity: 0.8; transition: opacity 0.3s; }
        .card:hover .thumb { opacity: 1; }
        .card-body { padding: 15px; border-top: 1px solid var(--border); }
        .card-title { margin: 0; font-size: 0.95rem; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.5px; }
        .card-cat { color: var(--cyan); font-size: 0.7rem; margin-top: 5px; display: block; text-transform: uppercase; letter-spacing: 1px;}

        #game-viewer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--dark); z-index: 5000; overflow-y: auto;
            display: none; opacity: 0; transition: opacity 0.3s ease;
        }
        #game-viewer.active { opacity: 1; }

        .gv-nav {
            height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            border-bottom: 1px solid var(--border); background: var(--panel);
            position: sticky; top: 0; z-index: 5001;
        }
        .back-btn { 
            background: transparent; border: 1px solid var(--danger); color: var(--danger); 
            padding: 5px 15px; border-radius: 4px; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
        }
        .back-btn:hover { background: var(--danger); color: black; }

        .gv-stage { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        .game-frame-wrapper {
            position: relative; width: 100%; padding-top: 56.25%; 
            background: black; border: 1px solid var(--border); border-radius: 4px; overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.05);
        }
        .game-loader-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; display: flex; align-items: center; justify-content: center;
            z-index: 5;
        }
        
        .game-frame-wrapper iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; z-index: 10;
        }
        
        .game-meta { 
            margin-top: 20px; background: var(--panel); padding: 20px; border: 1px solid var(--border); border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .fs-btn {
            background: var(--panel); color: white; border: 1px solid var(--border); 
            padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .fs-btn:hover { border-color: var(--cyan); color: var(--cyan); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; }

        .modal-box { 
            background: #0a0a0d; padding: 30px; border-radius: 8px; border: 1px solid var(--border); 
            width: 90%; max-width: 400px; text-align: center; position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .close-modal { position: absolute; top: 10px; right: 15px; color: #666; cursor: pointer; font-size: 1.5rem; }

        .modal-input {
            width: 100%; padding: 12px; background: #15151a; border: 1px solid #333; 
            color: white; border-radius: 4px; margin-bottom: 10px; font-size: 1rem; color: var(--cyan);
        }
        .action-btn {
            background: var(--cyan); color: black; border: none; padding: 12px; 
            width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .action-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

        #social-fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px; background: var(--panel); border: 1px solid var(--cyan);
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            color: var(--cyan); font-size: 1.2rem; cursor: pointer; z-index: 4000;
            box-shadow: 0 0 20px var(--cyan-dim); transition: 0.3s;
        }
        #social-fab:hover { background: var(--cyan-dim); transform: scale(1.1); }
        .fab-badge {
            position: absolute; top: -5px; right: -5px; background: var(--danger); color: white;
            width: 18px; height: 18px; border-radius: 50%; font-size: 0.7rem; 
            align-items: center; justify-content: center; font-weight: bold; display: none;
        }

        #social-panel {
            position: fixed; bottom: 85px; right: 20px; width: 350px; height: 500px;
            background: #0a0a0d; border: 1px solid var(--border); border-radius: 8px;
            z-index: 3999; transform: translateX(130%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        #social-panel.active { transform: translateX(0); }
        
        .social-tabs { display: flex; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; color: #666; cursor: pointer; border-bottom: 2px solid transparent; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .tab-btn.active { color: var(--cyan); border-bottom-color: var(--cyan); background: rgba(0, 242, 255, 0.02); }

        .social-body { flex: 1; overflow-y: auto; position: relative; }
        .social-view { display: none; padding: 0; }
        .social-view.active { display: block; }
        
        .friend-item, .req-item {
            display: flex; align-items: center; gap: 10px; padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.03); transition: 0.2s;
        }
        .friend-item:hover { background: rgba(255,255,255,0.03); cursor: pointer; }
        .f-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #333; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .status-dot.offline { background: #555; }

        #chat-interface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0d; z-index: 50; display: flex; flex-direction: column;
            transform: translateX(100%); transition: 0.3s ease;
        }
        #chat-interface.open { transform: translateX(0); }
        .chat-header { padding: 10px 15px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; word-wrap: break-word; }
        .msg.mine { align-self: flex-end; background: var(--cyan); color: black; }
        .msg.theirs { align-self: flex-start; background: #222; color: white; border: 1px solid #333; }
        .chat-input-area { padding: 10px; background: var(--panel); display: flex; gap: 10px; border-top: 1px solid var(--border); }
        .chat-input { flex: 1; background: #000; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; }

        .alert-box { border: 1px solid var(--danger); box-shadow: 0 0 20px rgba(255, 68, 68, 0.1); }
        .alert-btns { display: flex; gap: 10px; margin-top: 20px; }
        .alert-btn { flex: 1; padding: 10px; border: 1px solid #333; background: transparent; color: white; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .alert-btn.confirm { background: rgba(255, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }
        .alert-btn.confirm:hover { background: var(--danger); color: white; }

        .holo-card {
            background: linear-gradient(135deg, rgba(10,10,15,0.95), rgba(5,5,8,0.98));
            border: 1px solid var(--cyan-dim); box-shadow: 0 0 25px var(--cyan-dim);
            border-radius: 8px; padding: 20px; text-align: left;
        }
        .holo-header { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px; }
        .holo-info h2 { margin: 0; color: white; font-size: 1.2rem; text-transform: uppercase; }
        .holo-info span { color: var(--cyan); font-size: 0.7rem; letter-spacing: 1px; }
        .id-badge {
            background: var(--cyan-dim); color: var(--cyan); border: 1px dashed var(--cyan);
            padding: 10px; text-align: center; margin-top: 15px; font-family: monospace; font-size: 1rem;
            cursor: pointer; letter-spacing: 2px;
        }
        .xp-bar-container { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 15px 0 5px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--cyan); width: 0%; box-shadow: 0 0 10px var(--cyan); transition: width 1s ease; }
        .xp-meta { display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; }
        .badge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
        .holo-badge {
            aspect-ratio: 1; border: 1px solid #333; border-radius: 5px; background: rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #444;
        }
        .holo-badge.earned { border-color: var(--gold); color: var(--gold); box-shadow: 0 0 10px rgba(255,215,0,0.15); }
        .leaderboard-row { display: flex; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }
        .rank-num { width: 30px; font-weight: bold; color: var(--cyan); }
    </style>
</head>
<body>

<div class="crt-overlay"></div>

<div id="loader"><div class="spinner"></div></div>
<div id="nexus-toast-container"></div>

<nav>
    <div class="logo" onclick="goHome()">
        <i class="fas fa-atom"></i> <span style="margin-left:10px;">SCIENTIFIC NEXUS</span>
    </div>
    <div class="user-nav" id="auth-container">
        <span style="font-size:0.75rem; color:#666; letter-spacing:1px;">INITIALIZING UPLINK...</span>
    </div>
</nav>

<div id="app-content">
    <div class="hero reveal-on-scroll">
        <h1>Research Terminal</h1>
        <p>Advanced Tactical Simulations & Physics Modules</p>
    </div>

    <div class="controls reveal-on-scroll">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="SEARCH DATABASE..." onkeyup="filterGames()">
        </div>
        <div class="categories">
            <button class="cat-btn active" onclick="filterCat('All')">ALL MODULES</button>
            <button class="cat-btn" onclick="filterCat('Physics')">PHYSICS</button>
            <button class="cat-btn" onclick="filterCat('Strategy')">STRATEGY</button>
            <button class="cat-btn" onclick="filterCat('Action')">KINETIC</button>
        </div>
    </div>

    <div class="grid" id="game-grid"></div>
</div>

<div id="game-viewer">
    <div class="gv-nav">
        <div style="display:flex; align-items:center; gap:15px;">
             <button class="back-btn" onclick="closeGame()">
                <i class="fas fa-times"></i> <span>Terminate</span>
            </button>
            <span id="gv-title" style="font-weight:bold; color:white; letter-spacing:1px; text-transform:uppercase;">Simulation</span>
        </div>
        <button class="fs-btn" onclick="toggleFull()"><i class="fas fa-expand"></i></button>
    </div>
    
    <div class="gv-stage">
        <div class="game-frame-wrapper" id="gf-wrapper">
            <div class="game-loader-overlay" id="game-loader-ui">
                <div class="spinner"></div>
            </div>
            <iframe id="game-frame" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-pointer-lock" allowfullscreen></iframe>
        </div>
        
        <div class="game-meta">
            <div>
                <span style="color:#666; font-size:0.8rem; text-transform:uppercase; display:block;">Module Category</span>
                <span id="gv-cat" style="color:var(--cyan); font-weight:bold;">Physics</span>
            </div>
            <div style="text-align:right;">
                <span style="color:#666; font-size:0.8rem; text-transform:uppercase; display:block;">System Rating</span>
                <span style="color:var(--success); font-weight:bold;"><i class="fas fa-star"></i> 98.4%</span>
            </div>
        </div>
    </div>
</div>

<div id="social-fab" onclick="toggleSocialPanel()">
    <i class="fas fa-users"></i>
    <div class="fab-badge" id="global-badge">0</div>
</div>

<div id="social-panel">
    <div id="chat-interface">
        <div class="chat-header">
            <div style="color:var(--cyan); font-weight:bold; font-size:0.9rem;" id="chat-friend-name">Unknown</div>
            <div>
                <button onclick="openBlockModal()" style="background:none; border:none; color:#666; cursor:pointer; margin-right:10px;"><i class="fas fa-ban"></i></button>
                <button onclick="closeChat()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="chat-messages" id="chat-msgs"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Transmission..." onkeypress="handleChatKey(event)">
            <button onclick="sendMessage()" style="background:var(--cyan); border:none; width:35px; height:35px; border-radius:4px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="social-tabs">
        <button class="tab-btn active" onclick="switchTab('friends')">Allies</button>
        <button class="tab-btn" onclick="switchTab('ranking')">Ranking</button>
        <button class="tab-btn" onclick="switchTab('comms')">Comms</button>
        <button class="tab-btn" onclick="switchTab('blocked')" style="color:#ff6666;">Blacklist</button>
    </div>

    <div class="social-body">
        <div id="view-friends" class="social-view active">
            <div id="friends-list" style="padding-bottom:20px;">
                <div style="text-align:center; color:#666; margin-top:20px; font-size:0.8rem;">Searching neural net...</div>
            </div>
        </div>
        
        <div id="view-ranking" class="social-view" style="padding:15px;">
            <div style="color:#666; font-size:0.75rem; text-transform:uppercase; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">Top Researchers</div>
            <div id="leaderboard-list">
                <div style="text-align:center; color:#666; padding:10px;">Connecting to Global Mainframe...</div>
            </div>
        </div>

        <div id="view-comms" class="social-view" style="padding:15px;">
            <div style="font-size:0.7rem; color:#666; text-transform:uppercase; margin-bottom:10px;">Establish Link</div>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input type="text" id="invite-input-tab" class="modal-input" placeholder="ENTER ID" maxlength="16" style="margin:0; font-family:monospace; text-align:center;">
                <button onclick="sendInvite()" style="background:var(--cyan); border:none; border-radius:4px; width:40px; cursor:pointer;"><i class="fas fa-plus"></i></button>
            </div>
            <p id="invite-msg-tab" style="font-size:0.75rem; text-align:center; min-height:1em; margin:0 0 20px;"></p>
            
            <div style="font-size:0.7rem; color:#666; text-transform:uppercase; margin-bottom:10px;">Pending Signals</div>
            <div id="requests-list">
                 <div style="text-align:center; color:#666; font-size:0.8rem;">No incoming data.</div>
            </div>
        </div>

        <div id="view-blocked" class="social-view">
            <div id="blocked-list"></div>
        </div>
    </div>
</div>

<div id="block-confirm-modal" class="modal">
    <div class="modal-box alert-box">
        <h3 style="color:var(--danger); margin-top:0;">PROTOCOL ALERT</h3>
        <p style="color:#aaa; font-size:0.9rem;">Sever communication with this entity?<br>This action cannot be undone easily.</p>
        <div class="alert-btns">
            <button class="alert-btn" onclick="closeModal('block-confirm-modal')">Cancel</button>
            <button class="alert-btn confirm" onclick="confirmBlockUser()">Sever Link</button>
        </div>
    </div>
</div>

<div id="unblock-confirm-modal" class="modal">
    <div class="modal-box" style="border-color:var(--cyan);">
        <h3 style="color:var(--cyan); margin-top:0;">RESTORE LINK</h3>
        <p style="color:#aaa; font-size:0.9rem;">Re-establish connection protocols?</p>
        <div class="alert-btns">
            <button class="alert-btn" onclick="closeModal('unblock-confirm-modal')">Cancel</button>
            <button class="alert-btn" style="border-color:var(--cyan); color:var(--cyan);" onclick="confirmUnblockUser()">Restore</button>
        </div>
    </div>
</div>

<div id="login-modal" class="modal">
    <div class="modal-box">
        <span class="close-modal" onclick="closeModal('login-modal')">×</span>
        <h2 style="color:white; margin-top:0; font-size:1.2rem;">IDENTITY VERIFICATION</h2>
        <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Access classified saves and history.</p>
        <button onclick="loginGoogle()" style="background:white; color:black; border:none; padding:12px; width:100%; border-radius:4px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
    </div>
</div>

<div id="username-modal" class="modal" style="z-index: 6001;">
    <div class="modal-box">
        <h2 style="color:var(--cyan); margin-top:0; font-size:1.2rem;">CREATE ALIAS</h2>
        <input type="text" id="new-username" class="modal-input" placeholder="CODENAME (3-10 CHARS)" maxlength="10">
        <p id="username-error" style="color: #ff4444; font-size: 0.8rem; display: none; margin: 5px 0;"></p>
        <button id="submit-btn" onclick="submitUsername()" class="action-btn">ESTABLISH ID</button>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-box" style="background:transparent; border:none; box-shadow:none;">
        <span class="close-modal" onclick="closeModal('profile-modal')" style="right:0; top:-30px;">×</span>
        <div id="profile-content"></div>
        <button onclick="logout()" style="margin-top:20px; background:rgba(0,0,0,0.8); color:#ff4444; border:1px solid #333; padding:12px; width:100%; border-radius:4px; cursor:pointer; font-weight:bold; backdrop-filter:blur(5px);">
            <i class="fas fa-power-off"></i> DISCONNECT
        </button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

<script>
    // --- 1. SYSTEM INITIALIZATION ---
    function safeInit() {
        const loader = document.getElementById('loader');
        if(loader && !loader.classList.contains('hidden')) {
            loader.classList.add('hidden');
            render(); 
        }
    }
    // Init on load
    document.addEventListener("DOMContentLoaded", safeInit);
    setTimeout(safeInit, 3000);

    // --- 2. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCrgwoD_IVwlyvUQwDDQj6T772obSOL8So",
        authDomain: "scientificnexus-65c48.firebaseapp.com",
        projectId: "scientificnexus-65c48",
        storageBucket: "scientificnexus-65c48.firebasestorage.app",
        messagingSenderId: "125907587809",
        appId: "1:125907587809:web:d8068604db659fa357dda0",
        measurementId: "G-787GN5V4WT"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) {
        console.warn("Firebase Init Error (Check Console):", e);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUser = null;
    let userData = null; 
    let activeChatId = null;
    let currentChatUserUid = null;
    let targetUnblockUid = null;
    let chatUnsub = null;
    let friendStatusUnsubs = [];
    let globalMsgListener = null;

    // --- 3. GAME DATABASE ---
    const gameData = [
        { 
            title: "Truck Physics Challenge", 
            cat: "Physics", 
            url: "https://html5.gamedistribution.com/c7af7f58929a4a3c891ccf1192223a6a/", 
            thumb: "https://img.gamedistribution.com/c7af7f58929a4a3c891ccf1192223a6a-1280x720.jpg" 
        }
    ];

    // --- 4. RENDER LOGIC ---
    function render() {
        const grid = document.getElementById('game-grid');
        if(!grid) return;
        grid.innerHTML = '';
        gameData.forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    }

    function createCard(g) {
        const div = document.createElement('div');
        div.className = 'card reveal-on-scroll';
        div.innerHTML = `
            <img src="${g.thumb}" class="thumb" loading="lazy" onerror="this.src='https://via.placeholder.com/300x200?text=Module+Error'">
            <div class="card-body">
                <h3 class="card-title">${g.title}</h3>
                <span class="card-cat">${g.cat}</span>
            </div>
        `;
        div.onclick = () => openGame(g.url, g.title, g.cat);
        return div;
    }

    function observeElements() {
        if (window.globalObserver) window.globalObserver.disconnect();
        window.globalObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) entry.target.classList.add('reveal');
            });
        }, { threshold: 0.1 }); 
        document.querySelectorAll('.reveal-on-scroll').forEach(el => window.globalObserver.observe(el));
    }

    function openGame(baseUrl, title, cat) {
        const gv = document.getElementById('game-viewer');
        const loader = document.getElementById('game-loader-ui');
        
        const referrer = encodeURIComponent(window.location.href);
        const finalUrl = `${baseUrl}?gd_sdk_referrer_url=${referrer}`;
        
        gv.style.display = 'block'; 
        setTimeout(() => gv.classList.add('active'), 10);
        
        loader.style.display = 'flex';
        
        const iframe = document.getElementById('game-frame');
        iframe.src = finalUrl;
        
        iframe.onload = () => { loader.style.display = 'none'; };

        document.getElementById('gv-title').innerText = title;
        document.getElementById('gv-cat').innerText = cat;
    }

    function closeGame() {
        const gv = document.getElementById('game-viewer'); 
        gv.classList.remove('active');
        setTimeout(() => { 
            gv.style.display = 'none'; 
            document.getElementById('game-frame').src = "about:blank"; 
        }, 300);
    }
    
    function toggleFull() {
        const el = document.getElementById('gf-wrapper');
        !document.fullscreenElement ? el.requestFullscreen().catch(e=>{}) : document.exitFullscreen();
    }
    function goHome() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

    function showToast(iconClass, title, message) {
        const container = document.getElementById('nexus-toast-container');
        const toast = document.createElement('div');
        toast.className = 'nexus-toast';
        toast.innerHTML = `<i class="${iconClass} nt-icon"></i><div class="nt-content"><h4>${title}</h4><p>${message}</p></div>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('active'), 50);
        setTimeout(() => { toast.classList.remove('active'); setTimeout(() => toast.remove(), 500); }, 4000);
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // --- 5. AUTH & USER LOGIC ---
    function openLoginModal() { document.getElementById('login-modal').classList.add('active'); }
    function loginGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then(() => closeModal('login-modal'))
            .catch(err => alert("Login Error: " + err.message));
    }
    function logout() {
        if (globalMsgListener) globalMsgListener();
        friendStatusUnsubs.forEach(unsub => unsub());
        auth.signOut().then(() => window.location.reload());
    }

    auth.onAuthStateChanged(async (user) => {
        currentUser = user;
        const container = document.getElementById('auth-container');
        if (user) {
            startHeartbeat();
            
            // --- GLOBAL MONITOR START (UPGRADED) ---
            initGlobalMessageListener();

            db.collection('users').doc(user.uid).onSnapshot(snapshot => {
                if (snapshot.exists) {
                    userData = snapshot.data();
                    if (!userData.username) document.getElementById('username-modal').classList.add('active');
                    else {
                        if (!userData.commanderId) ensureCommanderId();
                        updateUIWithProfile();
                    }
                    loadSocialData();
                } else {
                    document.getElementById('username-modal').classList.add('active');
                }
            });
        } else {
            container.innerHTML = `<button class="auth-btn" onclick="openLoginModal()"><i class="fas fa-key"></i> ACCESS</button>`;
            document.getElementById('social-fab').style.display = 'none';
        }
    });

    function updateUIWithProfile() {
        if (!currentUser) return;
        const container = document.getElementById('auth-container');
        const displayName = (userData && userData.username) ? userData.username : "Recruit";
        const photo = currentUser.photoURL || "https://via.placeholder.com/32";
        container.innerHTML = `<button class="auth-btn" style="border-color:var(--cyan);" onclick="openProfileModal()"><img src="${photo}" class="user-avatar"><span>${displayName}</span></button>`;
        document.getElementById('social-fab').style.display = 'flex';
    }

    // --- 6. GLOBAL MONITOR (REBUILT FOR COLLECTION GROUP) ---
    function initGlobalMessageListener() {
        if (!currentUser) return;
        if (globalMsgListener) globalMsgListener();
        
        // UPGRADE: Uses collectionGroup to find ANY message where receiverId is ME and read is FALSE
        // NOTE: This requires a specific Index in Firestore. Check Console (F12) for the link if it fails.
        globalMsgListener = db.collectionGroup('messages')
            .where('receiverId', '==', currentUser.uid)
            .where('read', '==', false)
            .onSnapshot(snap => {
                const count = snap.size;
                const badge = document.getElementById('global-badge');
                
                badge.innerText = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
                
                // Animation for new messages
                if(count > 0 && !document.getElementById('social-panel').classList.contains('active')) {
                     const fab = document.getElementById('social-fab');
                     fab.style.boxShadow = "0 0 30px var(--danger)";
                     setTimeout(() => fab.style.boxShadow = "", 2000);
                }
            }, err => {
                console.error("GLOBAL MONITOR ERROR: If this says 'requires an index', CLICK THE LINK in the error message below to create it in Firebase Console.");
                console.error("MISSING INDEX URL:", err.message);
            });
    }

    // --- 7. PROFILE & GAMIFICATION ---
    function openProfileModal() {
        if (!currentUser) return;
        const safeUsername = userData?.username || "Loading...";
        const displayId = userData?.commanderId || "Syncing...";
        const photo = currentUser.photoURL;
        const xpData = calculateXP(userData.joined);

        const content = document.getElementById('profile-content');
        content.innerHTML = `
            <div class="holo-card">
                <div class="holo-header">
                    <img src="${photo}" style="width:60px; height:60px; border-radius:50%; border:2px solid var(--cyan);">
                    <div class="holo-info">
                        <h2>${safeUsername}</h2>
                        <span>CLEARANCE LEVEL ${xpData.level}</span>
                    </div>
                </div>
                
                <div class="xp-bar-container">
                    <div class="xp-fill" style="width:${xpData.percent}%"></div>
                </div>
                <div class="xp-meta">
                    <span>XP: ${xpData.current}/${xpData.next}</span>
                    <span>NEXT TIER</span>
                </div>

                <div class="id-badge" onclick="copyCode('${displayId}')">
                    <span style="display:block; font-size:0.7rem; color:#888;">COMMANDER ID (COPY)</span>${displayId}
                </div>
                
                <h4 style="color:var(--cyan); margin:20px 0 10px; font-size:0.8rem; text-transform:uppercase;">Achievements</h4>
                <div class="badge-grid">
                    <div class="holo-badge earned" title="Early Adopter"><i class="fas fa-satellite"></i></div>
                    <div class="holo-badge ${xpData.level > 1 ? 'earned' : ''}" title="Veteran"><i class="fas fa-meteor"></i></div>
                    <div class="holo-badge ${userData.friends && userData.friends.length > 0 ? 'earned' : ''}" title="Socialite"><i class="fas fa-link"></i></div>
                    <div class="holo-badge" title="Master"><i class="fas fa-crown"></i></div>
                </div>
            </div>`;
        document.getElementById('profile-modal').classList.add('active');
    }

    function calculateXP(joinedTimestamp) {
        if (!joinedTimestamp) return { current:0, next:500, level:1, percent:0 };
        const joined = joinedTimestamp.toMillis ? joinedTimestamp.toMillis() : Date.now();
        const days = Math.max(1, Math.floor((Date.now() - joined) / (1000 * 60 * 60 * 24)));
        const totalXP = (days * 50) + 100;
        const level = Math.floor(totalXP / 500) + 1;
        const nextLevelXP = level * 500;
        const currentLevelXP = (level - 1) * 500;
        const percent = ((totalXP - currentLevelXP) / 500) * 100;
        return { current: totalXP, next: nextLevelXP, level, percent };
    }

    function generateCommanderId() { return `${Math.floor(10000000 + Math.random() * 90000000)}${Math.floor(10000000 + Math.random() * 90000000)}`; }

    async function ensureCommanderId() {
        if (!userData || userData.commanderId) return;
        const newId = generateCommanderId();
        const batch = db.batch();
        batch.set(db.collection("friend_codes").doc(newId), { uid: currentUser.uid, username: userData.username || "Unknown" });
        batch.update(db.collection("users").doc(currentUser.uid), { commanderId: newId });
        await batch.commit();
    }
    function copyCode(code) { navigator.clipboard.writeText(code); showToast("fas fa-copy", "System", "ID copied."); }

    async function submitUsername() {
        const input = document.getElementById('new-username');
        const errorMsg = document.getElementById('username-error');
        const btn = document.getElementById('submit-btn');
        const username = input.value.trim();
        
        if (!/^[a-zA-Z0-9]{3,10}$/.test(username)) { 
            errorMsg.innerText = "Error: Alphanumeric, 3-10 chars only."; errorMsg.style.display = 'block'; return; 
        }
        
        btn.disabled = true; btn.innerText = "PROCESSING...";
        try {
            const check = await db.collection('usernames').doc(username).get();
            if (check.exists && check.data().uid !== currentUser.uid) { 
                errorMsg.innerText = "Alias taken."; errorMsg.style.display = 'block'; btn.disabled = false; return; 
            }
            const batch = db.batch();
            const cId = userData?.commanderId || generateCommanderId();
            
            if (!userData?.commanderId) batch.set(db.collection('friend_codes').doc(cId), { uid: currentUser.uid, username: username });
            batch.set(db.collection('usernames').doc(username), { uid: currentUser.uid });
            batch.set(db.collection('users').doc(currentUser.uid), {
                username: username, commanderId: cId, uid: currentUser.uid,
                photoURL: currentUser.photoURL, email: currentUser.email,
                joined: userData?.joined || firebase.firestore.FieldValue.serverTimestamp(),
                friends: userData?.friends || [], blocked: userData?.blocked || []
            }, { merge: true });
            
            await batch.commit(); window.location.reload();
        } catch (e) { errorMsg.innerText = "Error: " + e.message; btn.disabled = false; }
    }

    // --- 8. SOCIAL LOGIC ---
    function loadSocialData() {
        if (!currentUser) return;
        db.collection('friend_requests').where('toUid', '==', currentUser.uid).onSnapshot(snap => {
            const list = document.getElementById('requests-list');
            let html = '';
            snap.forEach(doc => { const d = doc.data();
                html += `<div class="req-item"><div style="flex:1;"><div style="color:white; font-size:0.8rem;">${d.fromName}</div></div><button onclick="acceptRequest('${doc.id}', '${d.fromUid}', '${d.fromName}')" style="background:var(--success); border:none; color:black; border-radius:4px; padding:2px 8px; cursor:pointer;">Accept</button></div>`;
            });
            list.innerHTML = html || '<div style="text-align:center; color:#666; padding:10px;">No pending signals.</div>';
        });
        if(userData) { renderFriends(userData.friends || []); renderBlocked(userData.blocked || []); }
    }

    function loadLeaderboard() {
        const div = document.getElementById('leaderboard-list');
        db.collection('users').orderBy('joined', 'asc').limit(10).get().then(snap => {
            let html = '';
            let rank = 1;
            snap.forEach(doc => {
                const d = doc.data();
                html += `
                <div class="leaderboard-row">
                    <div class="rank-num">#${rank++}</div>
                    <div style="flex:1;">${d.username || 'Unknown'}</div>
                    <div style="color:var(--cyan); font-size:0.7rem;">LVL ${calculateXP(d.joined).level}</div>
                </div>`;
            });
            div.innerHTML = html;
        });
    }

    function renderFriends(arr) {
        const list = document.getElementById('friends-list');
        friendStatusUnsubs.forEach(u => u()); friendStatusUnsubs = [];
        if (!arr.length) { list.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px; font-size:0.8rem;">No allies connected.</div>'; return; }
        
        list.innerHTML = ''; 
        const unique = [...new Map(arr.map(item => [item.uid, item])).values()];
        
        unique.forEach(f => {
            const div = document.createElement('div'); div.className = 'friend-item';
            div.innerHTML = `<img src="https://ui-avatars.com/api/?name=${f.username}&background=00f2ff&color=000" class="f-avatar"><div style="flex:1;"><div style="color:white; font-size:0.9rem;">${f.username}</div><div style="color:#666; font-size:0.75rem;" id="status-${f.uid}">Offline</div></div><i class="far fa-comment-alt" style="color:#666"></i>`;
            div.onclick = () => openChat(f.uid, f.username);
            list.appendChild(div);
            
            friendStatusUnsubs.push(db.collection('users').doc(f.uid).onSnapshot(d => {
                if(d.exists) {
                    const isOnline = (Date.now() - (d.data().lastSeen?.toMillis() || 0)) < 60000;
                    const el = document.getElementById(`status-${f.uid}`);
                    if(el) el.innerHTML = isOnline ? `<span class="status-dot online"></span> Active` : `<span class="status-dot offline"></span> Offline`;
                }
            }));
        });
    }

    function renderBlocked(arr) {
        const list = document.getElementById('blocked-list');
        list.innerHTML = arr.length ? '' : '<div style="text-align:center; color:#666; margin-top:20px; font-size:0.8rem;">No blocked entities.</div>';
        arr.forEach(b => {
             list.innerHTML += `<div class="friend-item" style="cursor:default;"><div style="flex:1; color:#888;">${b.username}</div><button onclick="openUnblockModal('${b.uid}')" style="background:none; border:1px solid var(--cyan); color:var(--cyan); border-radius:4px; font-size:0.7rem; cursor:pointer;">RESTORE</button></div>`;
        });
    }

    function startHeartbeat() {
        const beat = () => { if(currentUser) db.collection("users").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{}); };
        beat(); setInterval(beat, 45000); 
    }

    async function sendInvite() {
        const input = document.getElementById('invite-input-tab');
        const msg = document.getElementById('invite-msg-tab');
        const code = input.value.trim();
        if (code.length < 5) return;
        
        try {
            const codeDoc = await db.collection('friend_codes').doc(code).get();
            if (!codeDoc.exists) { msg.innerText = "Target invalid."; msg.style.color = 'var(--danger)'; return; }
            const targetUid = codeDoc.data().uid;
            if (targetUid === currentUser.uid || userData.friends.some(f=>f.uid===targetUid)) { msg.innerText = "Already linked."; return; }
            await db.collection('friend_requests').add({ fromUid: currentUser.uid, fromName: userData.username, toUid: targetUid, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            msg.innerText = "Signal sent."; msg.style.color = 'var(--success)'; input.value = '';
        } catch (e) { msg.innerText = "Error."; }
    }

    async function acceptRequest(reqId, fromUid, fromName) {
        const batch = db.batch();
        batch.update(db.collection('users').doc(currentUser.uid), { friends: firebase.firestore.FieldValue.arrayUnion({ uid: fromUid, username: fromName }) });
        batch.update(db.collection('users').doc(fromUid), { friends: firebase.firestore.FieldValue.arrayUnion({ uid: currentUser.uid, username: userData.username }) });
        batch.delete(db.collection('friend_requests').doc(reqId));
        await batch.commit();
    }

    // --- 9. CHAT (UPGRADED FOR BATCH READ & COLLECTION GROUP) ---
    function openChat(friendUid, friendName) {
        currentChatUserUid = friendUid;
        document.getElementById('chat-friend-name').innerText = friendName;
        document.getElementById('chat-interface').classList.add('open');
        
        // Consistent Chat ID generation
        activeChatId = [currentUser.uid, friendUid].sort().join('_');
        
        const msgContainer = document.getElementById('chat-msgs');
        if(chatUnsub) chatUnsub();
        
        chatUnsub = db.collection('chats').doc(activeChatId).collection('messages')
            .orderBy('timestamp', 'asc').limit(50)
            .onSnapshot(snap => {
                msgContainer.innerHTML = '';
                
                // UPGRADE: Batch process for read receipts
                const batch = db.batch();
                let batchCount = 0;
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = `msg ${d.senderId === currentUser.uid ? 'mine' : 'theirs'}`;
                    div.innerText = d.text;
                    msgContainer.appendChild(div);
                    
                    // Add to batch if unread and meant for me
                    if(d.receiverId === currentUser.uid && d.read === false) {
                        batch.update(doc.ref, { read: true });
                        batchCount++;
                    }
                });
                
                msgContainer.scrollTop = msgContainer.scrollHeight;
                
                // Commit batch if we have updates
                if (batchCount > 0) {
                    batch.commit().catch(e => console.error("Batch Read Receipt Error:", e));
                }
            });
    }

    function closeChat() { document.getElementById('chat-interface').classList.remove('open'); if (chatUnsub) chatUnsub(); }
    
    function sendMessage() {
        const input = document.getElementById('chat-input');
        const txt = input.value.trim();
        if (!txt || !activeChatId || !currentChatUserUid) return;
        
        // UPGRADE: Added receiverId and read fields to support CollectionGroup query
        db.collection('chats').doc(activeChatId).collection('messages').add({ 
            text: txt, 
            senderId: currentUser.uid, 
            receiverId: currentChatUserUid, // Crucial for Global Monitor
            read: false,                    // Crucial for Read Receipts
            timestamp: firebase.firestore.FieldValue.serverTimestamp() 
        });
        input.value = '';
    }
    function handleChatKey(e) { if (e.key === 'Enter') sendMessage(); }

    // --- 10. NAVIGATION ---
    function toggleSocialPanel() { 
        if (!currentUser) { alert("Login required."); return; } 
        document.getElementById('social-panel').classList.toggle('active'); 
    }
    
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.social-view').forEach(v => v.classList.remove('active'));
        
        const idx = tab==='friends'?0 : tab==='ranking'?1 : tab==='comms'?2 : 3;
        document.querySelectorAll('.tab-btn')[idx].classList.add('active');
        document.getElementById(`view-${tab}`).classList.add('active');
        
        if(tab === 'ranking') loadLeaderboard();
    }
    
    function filterCat(cat) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        const grid = document.getElementById('game-grid'); grid.innerHTML = '';
        (cat === 'All' ? gameData : gameData.filter(g => g.cat === cat)).forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    }
    function filterGames() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const grid = document.getElementById('game-grid'); grid.innerHTML = '';
        gameData.filter(g => g.title.toLowerCase().includes(q)).forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    }
    
    function openBlockModal() { document.getElementById('block-confirm-modal').classList.add('active'); }
    function openUnblockModal(uid) { targetUnblockUid = uid; document.getElementById('unblock-confirm-modal').classList.add('active'); }
    
    function confirmBlockUser() {
        const friendName = document.getElementById('chat-friend-name').innerText;
        const batch = db.batch();
        batch.update(db.collection('users').doc(currentUser.uid), { 
            friends: firebase.firestore.FieldValue.arrayRemove({ uid: currentChatUserUid, username: friendName }), 
            blocked: firebase.firestore.FieldValue.arrayUnion({ uid: currentChatUserUid, username: friendName }) 
        });
        batch.commit().then(() => { closeModal('block-confirm-modal'); closeChat(); });
    }
    function confirmUnblockUser() { 
        if(!targetUnblockUid) return; 
        const blockedObj = userData.blocked.find(b => b.uid === targetUnblockUid);
        if(blockedObj) db.collection('users').doc(currentUser.uid).update({ blocked: firebase.firestore.FieldValue.arrayRemove(blockedObj) });
        closeModal('unblock-confirm-modal');
    }
</script>
</body>
</html>