<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050507">
    <meta name="description" content="Scientific Nexus Research Terminal - Advanced Physics & Strategy Simulations">
    
    <link rel="manifest" href="/manifest.json">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>Scientific Nexus | Research Terminal 2.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root { 
            --bg-root: #050507;
            --bg-panel: #0f0f13;
            --accent-cyan: #00f2ff;
            --accent-purple: #bc13fe;
            --text-main: #e0e0e0;
            --text-muted: #888888;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(15, 15, 19, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --danger: #ff4444;
            --success: #00ff88;
            --gold: #ffd700;
            --header-h: 70px;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg-root); color: var(--text-main); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; overflow-x: hidden; min-height: 100vh;
        }

        /* --- 2. CRT & LOADER UTILITIES --- */
        .crt-scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 9000; opacity: 0.6;
        }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-root);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        #loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .spinner {
            width: 40px; height: 40px; border: 2px solid var(--border-color); 
            border-top: 2px solid var(--accent-cyan); border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 3. NAVIGATION (Crisp, Glass) --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; background: rgba(5, 5, 7, 0.95);
            backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color);
            position: fixed; width: 100%; top: 0; z-index: 1000; height: var(--header-h);
        }
        .logo { 
            font-weight: 700; color: var(--accent-cyan); letter-spacing: 2px; font-size: 1rem; 
            text-transform: uppercase; display: flex; align-items: center; gap: 12px; cursor: pointer;
        }
        .auth-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 8px 20px; border-radius: 2px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 10px; font-size: 0.75rem; letter-spacing: 1px;
            text-transform: uppercase;
        }
        .auth-btn:hover { border-color: var(--accent-cyan); background: rgba(0, 242, 255, 0.05); }
        .user-avatar { width: 28px; height: 28px; border-radius: 2px; border: 1px solid var(--border-color); }

        /* --- 4. MAIN LAYOUT --- */
        #app-content { padding-top: var(--header-h); min-height: 100vh; display: flex; flex-direction: column; padding-bottom: 60px; }
        
        .hero {
            padding: 60px 20px 40px; text-align: center; border-bottom: 1px solid var(--border-color);
            background: linear-gradient(to bottom, #0a0a0e, var(--bg-root));
        }
        .hero h1 { font-size: 2rem; margin: 0 0 10px; color: white; text-transform: uppercase; letter-spacing: 4px; font-weight: 400; }
        .hero p { color: var(--accent-cyan); font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; opacity: 0.7; }

        .controls { max-width: 1400px; margin: 30px auto; padding: 0 20px; width: 100%; }
        
        .search-bar {
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 2px;
            padding: 0 20px; display: flex; align-items: center; gap: 15px; margin-bottom: 25px;
            height: 48px; transition: border-color 0.2s;
        }
        .search-bar:focus-within { border-color: var(--accent-cyan); }
        .search-bar i { color: #555; font-size: 0.9rem; }
        .search-bar input { background: transparent; border: none; color: white; width: 100%; font-size: 0.9rem; letter-spacing: 0.5px; }

        .categories { 
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; 
            scrollbar-width: none; border-bottom: 1px solid var(--border-color);
        }
        .categories::-webkit-scrollbar { display: none; }
        
        .cat-btn {
            background: transparent; color: #666; border: none; border-bottom: 2px solid transparent;
            padding: 10px 15px; cursor: pointer; font-size: 0.75rem; 
            text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; white-space: nowrap;
        }
        .cat-btn:hover { color: var(--text-main); }
        .cat-btn.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }

        /* --- 5. GRID & CARDS (Static, Professional) --- */
        .grid { 
            display: grid; gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); width: 100%;
        }

        .card { 
            background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 2px; 
            overflow: hidden; cursor: pointer; transition: border-color 0.2s;
            display: flex; flex-direction: column;
        }
        .card:hover { border-color: var(--accent-cyan); }
        .thumb { height: 160px; width: 100%; object-fit: cover; opacity: 0.7; transition: opacity 0.2s; background: #000; }
        .card:hover .thumb { opacity: 1; }
        .card-body { padding: 15px; border-top: 1px solid var(--border-color); flex: 1; }
        .card-title { margin: 0; font-size: 0.85rem; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; text-transform: uppercase; }
        .card-cat { color: var(--accent-purple); font-size: 0.65rem; margin-top: 6px; display: block; text-transform: uppercase; letter-spacing: 1px;}

        /* --- 6. MODALS (Glassmorphism & New Layout) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; }

        /* Standard Modal Box */
        .modal-box { 
            background: var(--bg-panel); padding: 30px; border: 1px solid var(--border-color); 
            width: 100%; max-width: 400px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        /* NEW: Expanded Profile Modal */
        .modal-box.profile-expanded {
            max-width: 900px; width: 95%; height: 600px; max-height: 90vh;
            display: grid; grid-template-columns: 280px 1fr; padding: 0;
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); overflow: hidden;
        }

        /* Profile Sidebar */
        .p-sidebar {
            background: rgba(0,0,0,0.3); border-right: 1px solid var(--border-color);
            padding: 30px 20px; display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .p-avatar-lg { width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--accent-cyan); object-fit: cover; margin-bottom: 15px; }
        .p-username { color: white; font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .p-rank { color: var(--accent-cyan); font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 20px; }
        .p-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: auto; }
        .p-stat-box { background: rgba(255,255,255,0.03); padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; }
        .p-stat-val { display: block; font-size: 1rem; color: white; font-weight: bold; }
        .p-stat-label { font-size: 0.6rem; color: #888; text-transform: uppercase; }

        /* Profile Content Area */
        .p-content { display: flex; flex-direction: column; overflow: hidden; }
        .p-nav { display: flex; border-bottom: 1px solid var(--border-color); padding: 0 20px; background: rgba(0,0,0,0.2); }
        .p-tab-btn {
            background: none; border: none; padding: 15px 20px; color: #888; cursor: pointer;
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid transparent;
        }
        .p-tab-btn.active { color: white; border-bottom-color: var(--accent-cyan); }
        .p-scroll-area { padding: 30px; overflow-y: auto; flex: 1; }
        
        /* Security Toggles */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .setting-info h4 { margin: 0 0 5px; color: white; font-size: 0.9rem; }
        .setting-info p { margin: 0; color: #888; font-size: 0.75rem; }
        
        .toggle-switch {
            position: relative; width: 40px; height: 20px; background: #333; border-radius: 20px; cursor: pointer; transition: 0.3s;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; 
            background: white; border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch.active { background: var(--accent-cyan); }
        .toggle-switch.active::after { transform: translateX(20px); }

        /* Session List */
        .session-item {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            padding: 15px; margin-bottom: 10px; border-radius: 4px; display: flex; align-items: center; gap: 15px;
        }
        .session-icon { font-size: 1.2rem; color: var(--accent-purple); }

        /* Standard Inputs/Buttons */
        .modal-input {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); 
            color: white; margin-bottom: 10px; font-size: 0.9rem; font-family: inherit;
        }
        .action-btn {
            background: var(--accent-cyan); color: black; border: none; padding: 12px; 
            width: 100%; cursor: pointer; font-weight: 700; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 1px; font-size: 0.75rem;
        }

        .close-modal-corner { position: absolute; top: 15px; right: 20px; color: #666; cursor: pointer; font-size: 1.2rem; z-index: 10; }
        .close-modal-corner:hover { color: white; }

        /* --- 7. GAME VIEWER --- */
        #game-viewer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg-root); z-index: 5000; display: none;
        }
        .gv-nav {
            height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            border-bottom: 1px solid var(--border-color); background: var(--bg-panel);
        }
        .gv-stage { max-width: 1200px; margin: 20px auto; padding: 0 20px; height: calc(100vh - 100px); display: flex; flex-direction: column; }
        .game-frame-wrapper {
            position: relative; width: 100%; flex: 1; background: black; border: 1px solid var(--border-color);
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* --- 8. SOCIAL FAB & PANEL --- */
        #social-fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px; background: var(--bg-panel); border: 1px solid var(--border-color);
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            color: var(--accent-cyan); cursor: pointer; z-index: 4000; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: 0.3s;
        }
        #social-fab:hover { border-color: var(--accent-cyan); color: white; }
        
        #social-panel {
            position: fixed; bottom: 80px; right: 20px; width: 340px; height: 500px; max-height: 70vh;
            background: var(--bg-panel); border: 1px solid var(--border-color);
            z-index: 3999; transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        #social-panel.active { transform: translateX(0); }

        .social-tabs { display: flex; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.2); }
        .tab-btn { flex: 1; padding: 12px 5px; background: none; border: none; color: #666; cursor: pointer; border-bottom: 2px solid transparent; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .tab-btn.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
        .social-body { flex: 1; overflow-y: auto; position: relative; }
        .social-view { display: none; padding: 0; }
        .social-view.active { display: block; }

        /* Chat Interface */
        #chat-interface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-panel); z-index: 50; display: flex; flex-direction: column;
            transform: translateX(100%); transition: 0.3s ease;
        }
        #chat-interface.open { transform: translateX(0); }
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 4px; font-size: 0.85rem; }
        .msg.mine { align-self: flex-end; background: rgba(0, 242, 255, 0.1); border: 1px solid var(--accent-cyan); color: white; }
        .msg.theirs { align-self: flex-start; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); }

        /* Toast */
        .nexus-toast {
            position: fixed; top: 80px; right: 20px; background: var(--bg-panel);
            border-left: 3px solid var(--accent-cyan); padding: 15px; width: 300px;
            display: flex; align-items: center; gap: 15px; transform: translateX(150%); transition: 0.4s; z-index: 7000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .nexus-toast.active { transform: translateX(0); }

        /* Ad Container */
        .ad-uplink-container {
            max-width: 1400px; margin: 20px auto; padding: 15px;
            background: var(--bg-panel); border: 1px dashed var(--border-color);
            text-align: center; border-radius: 2px; overflow: hidden; width: 95%;
        }

        /* Footer */
        .footer-terminal {
            text-align: center; padding: 20px; margin-top: 40px;
            border-top: 1px solid var(--border-color); font-size: 0.75rem; color: #555;
        }
        .footer-link { cursor: pointer; margin: 0 10px; transition: 0.2s; }
        .footer-link:hover { color: var(--accent-cyan); }

        /* Mobile Responsive */
        @media screen and (max-width: 768px) {
            .modal-box.profile-expanded { grid-template-columns: 1fr; height: 100%; max-height: 100%; border: none; }
            .p-sidebar { flex-direction: row; padding: 15px; text-align: left; gap: 15px; border-bottom: 1px solid var(--border-color); border-right: none; }
            .p-avatar-lg { width: 60px; height: 60px; margin: 0; }
            .p-stat-grid { display: none; } /* Hide stats on mobile to save space */
            .p-username { font-size: 1rem; }
            .grid { grid-template-columns: 1fr; padding: 0 20px; }
            .search-bar { padding: 0 15px; }
        }
    </style>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6504872858297214" crossorigin="anonymous"></script>
</head>
<body>

<div class="crt-scanline"></div>

<div id="loader"><div class="spinner"></div></div>
<div id="nexus-toast-container"></div>

<nav>
    <div class="logo" onclick="goHome()">
        <i class="fas fa-cube"></i> <span>NEXUS TERMINAL</span>
    </div>
    <div class="user-nav" id="auth-container">
        </div>
</nav>

<div id="app-content">
    <div class="hero reveal-on-scroll">
        <h1>Research Terminal</h1>
        <p>Advanced Tactical Simulations & Physics Modules</p>
    </div>

    <div class="ad-uplink-container reveal-on-scroll">
        <span style="font-size: 0.6rem; color: #444; letter-spacing: 2px; display: block; margin-bottom: 10px;">SPONSORED UPLINK</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6504872858297214"
             data-ad-slot="5786114760"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div class="controls reveal-on-scroll">
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search database protocols..." onkeyup="filterGames()">
        </div>
        
        <div class="categories">
            <button class="cat-btn active" onclick="filterCat('All')">All</button>
            <button class="cat-btn" onclick="filterCat('Action')">Action</button>
            <button class="cat-btn" onclick="filterCat('Strategy')">Strategy</button>
            <button class="cat-btn" onclick="filterCat('Physics')">Physics</button>
            <button class="cat-btn" onclick="filterCat('Puzzle')">Puzzle</button>
            <button class="cat-btn" onclick="filterCat('Simulation')">Simulation</button>
            <button class="cat-btn" onclick="filterCat('Arcade')">Arcade</button>
            <button class="cat-btn" onclick="filterCat('Sports & Racing')">Sports</button>
            <button class="cat-btn" onclick="filterCat('Casual')">Casual</button>
            <button class="cat-btn" onclick="filterCat('Educational')">Educational</button>
        </div>
    </div>

    <div class="grid" id="game-grid"></div>
    
    <div class="footer-terminal reveal-on-scroll">
        <div style="margin-bottom: 10px;">SCIENTIFIC NEXUS TERMINAL v2.1 // CLASSIC BUILD</div>
        <span class="footer-link" onclick="openProtocols()">SYSTEM PROTOCOLS</span>
        <span class="footer-link" onclick="openProtocols()">DATA MANIFEST</span>
        <div style="margin-top: 10px; opacity: 0.5;">Secure Connection Established</div>
    </div>
</div>

<div id="game-viewer">
    <div class="gv-nav">
        <div style="display:flex; align-items:center; gap:15px;">
             <button onclick="closeGame()" style="background:transparent; border:1px solid var(--danger); color:var(--danger); padding:6px 12px; cursor:pointer; text-transform:uppercase; font-size:0.75rem;">
                <i class="fas fa-times"></i> Terminate
            </button>
            <span id="gv-title" style="font-weight:700; color:white; letter-spacing:1px; text-transform:uppercase;">Simulation</span>
        </div>
        <button onclick="toggleFull()" style="background:transparent; border:1px solid #444; color:white; padding:6px 12px; cursor:pointer;"><i class="fas fa-expand"></i></button>
    </div>
    
    <div class="gv-stage">
        <div class="game-frame-wrapper" id="gf-wrapper">
            <div id="game-loader-ui" style="position:absolute; top:0; left:0; width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; z-index:5;">
                <div class="spinner"></div>
            </div>
            <iframe id="game-frame" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-pointer-lock" allowfullscreen></iframe>
        </div>
        <div style="margin-top:15px; display:flex; justify-content:space-between; color:#666; font-size:0.8rem;">
            <span id="gv-cat">CATEGORY: PHYSICS</span>
            <span>RATING: 98.4%</span>
        </div>
    </div>
</div>

<div id="social-fab" onclick="toggleSocialPanel()">
    <i class="fas fa-users"></i>
    <div id="global-badge" style="position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; width:20px; height:20px; border-radius:50%; font-size:0.6rem; display:none; align-items:center; justify-content:center;">0</div>
</div>

<div id="social-panel">
    <div id="chat-interface">
        <div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
            <span id="chat-friend-name" style="color:var(--accent-cyan); font-weight:bold;">Unknown</span>
            <div>
                <button onclick="openBlockModal()" style="background:none; border:none; color:#666; cursor:pointer; margin-right:10px;"><i class="fas fa-ban"></i></button>
                <button onclick="closeChat()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="chat-msgs" id="chat-msgs"></div>
        <div style="padding:15px; border-top:1px solid var(--border-color); display:flex; gap:10px;">
            <input type="text" id="chat-input" placeholder="Transmission..." onkeypress="handleChatKey(event)" style="flex:1; background:rgba(0,0,0,0.3); border:1px solid #333; color:white; padding:8px;">
            <button onclick="sendMessage()" style="background:var(--accent-cyan); border:none; width:35px; border-radius:2px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="social-tabs">
        <button class="tab-btn active" onclick="switchTab('friends')">Allies</button>
        <button class="tab-btn" onclick="switchTab('ranking')">Ranking</button>
        <button class="tab-btn" onclick="switchTab('comms')">Comms</button>
    </div>

    <div class="social-body">
        <div id="view-friends" class="social-view active">
            <div id="friends-list" style="padding:15px;"></div>
        </div>
        <div id="view-ranking" class="social-view" style="padding:15px;">
            <div id="leaderboard-list"></div>
        </div>
        <div id="view-comms" class="social-view" style="padding:15px;">
            <div style="margin-bottom:15px; display:flex; gap:5px;">
                <input type="text" id="invite-input-tab" placeholder="ENTER ID" style="flex:1; background:#222; border:1px solid #444; color:white; padding:8px; text-align:center;">
                <button onclick="sendInvite()" style="background:var(--accent-cyan); border:none; padding:0 15px; cursor:pointer;"><i class="fas fa-plus"></i></button>
            </div>
            <p id="invite-msg-tab" style="font-size:0.75rem; text-align:center; min-height:1em; color:#888;"></p>
            <div id="requests-list"></div>
        </div>
    </div>
</div>

<div id="login-modal" class="modal">
    <div class="modal-box">
        <span class="close-modal-corner" onclick="closeModal('login-modal')">×</span>
        <h2 style="color:white; margin-top:0; font-size:1.2rem; text-transform:uppercase;">Identity Verification</h2>
        <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Access classified saves and history.</p>
        <button onclick="loginGoogle()" style="background:white; color:black; border:none; padding:12px; width:100%; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
    </div>
</div>

<div id="username-modal" class="modal" style="z-index: 6001;">
    <div class="modal-box">
        <h2 style="color:var(--accent-cyan); margin-top:0;">CREATE ALIAS</h2>
        <input type="text" id="new-username" class="modal-input" placeholder="CODENAME (3-10 CHARS)" maxlength="10">
        <p id="username-error" style="color: var(--danger); font-size: 0.8rem; display: none;"></p>
        <button id="submit-btn" onclick="submitUsername()" class="action-btn">ESTABLISH ID</button>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-box profile-expanded" id="profile-modal-content">
        </div>
</div>

<div id="protocols-modal" class="modal">
    <div class="modal-box" style="max-width:600px; max-height:80vh; overflow-y:auto;">
        <span class="close-modal-corner" onclick="closeModal('protocols-modal')">×</span>
        <h2 style="color:var(--accent-cyan); margin-top:0;">SYSTEM PROTOCOLS</h2>
        <div style="color:#ccc; font-size:0.85rem; line-height:1.6;">
            <p><strong>1.0 MISSION DIRECTIVE:</strong> The Scientific Nexus Research Terminal (SNRT) aggregates high-fidelity HTML5 simulations for cognitive reflex testing.</p>
            <p><strong>2.0 NEURAL LINK PRIVACY:</strong> We utilize Google Firebase Authentication. We do not store passwords. Chat logs are encrypted in transit. By using this terminal, you consent to standard functional cookies.</p>
            <p><strong>3.0 THIRD-PARTY UPLINKS:</strong> We utilize Google AdSense to maintain server operations. You may opt out of personalized advertising via your Google Ad Settings.</p>
            <p><strong>4.0 SUPPORT:</strong> Contact repository maintainers via GitHub for technical assistance.</p>
        </div>
    </div>
</div>

<div id="block-confirm-modal" class="modal">
    <div class="modal-box" style="border-color:var(--danger);">
        <h3 style="color:var(--danger); margin-top:0;">ALERT</h3>
        <p style="color:#aaa;">Sever communication link?</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeModal('block-confirm-modal')" style="flex:1; padding:10px; background:transparent; border:1px solid #444; color:white; cursor:pointer;">CANCEL</button>
            <button onclick="confirmBlockUser()" style="flex:1; padding:10px; background:var(--danger); border:none; color:black; cursor:pointer;">SEVER</button>
        </div>
    </div>
</div>

<div id="unblock-confirm-modal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--accent-cyan); margin-top:0;">RESTORE</h3>
        <p style="color:#aaa;">Re-establish connection?</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeModal('unblock-confirm-modal')" style="flex:1; padding:10px; background:transparent; border:1px solid #444; color:white; cursor:pointer;">CANCEL</button>
            <button onclick="confirmUnblockUser()" style="flex:1; padding:10px; background:var(--accent-cyan); border:none; color:black; cursor:pointer;">CONFIRM</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, where, orderBy, limit, 
        serverTimestamp, writeBatch, collectionGroup, setDoc, getDoc, arrayUnion, arrayRemove 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- SYSTEM INIT ---
    function safeInit() {
        const loader = document.getElementById('loader');
        if(loader && !loader.classList.contains('hidden')) {
            loader.classList.add('hidden');
            render(); 
        }
    }
    document.addEventListener("DOMContentLoaded", safeInit);
    setTimeout(safeInit, 3000);

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCrgwoD_IVwlyvUQwDDQj6T772obSOL8So",
        authDomain: "scientificnexus-65c48.firebaseapp.com",
        projectId: "scientificnexus-65c48",
        storageBucket: "scientificnexus-65c48.firebasestorage.app",
        messagingSenderId: "125907587809",
        appId: "1:125907587809:web:d8068604db659fa357dda0",
        measurementId: "G-787GN5V4WT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let userData = null; 
    let activeChatId = null;
    let currentChatUserUid = null;
    let targetUnblockUid = null;
    let chatUnsub = null;
    let friendStatusUnsubs = [];
    let globalMsgListener = null;

    // --- GAME DATA ---
    const gameData = [
       { title: "SkillFull Finger", cat: "Physics", url: "https://html5.gamedistribution.com/c7af7f58929a4a3c891ccf1192223a6a/", thumb: "https://img.gamedistribution.com/c7af7f58929a4a3c891ccf1192223a6a-1280x720.jpg" },
       { title: "Football Duel", cat: "Sports & Racing", url: "https://html5.gamedistribution.com/4a9c7ad53f7c48678b3b848390a62daa/", thumb: "https://img.gamedistribution.com/4a9c7ad53f7c48678b3b848390a62daa-1280x720.jpg" },
       { title: "Tap it Away 3D", cat: "Puzzle", url: "https://html5.gamedistribution.com/87cb43c5492049b49b01491248d9ced1/", thumb: "https://img.gamedistribution.com/87cb43c5492049b49b01491248d9ced1-1280x720.jpg" },
       { title: "Zombie Survival", cat: "Action", url: "https://html5.gamedistribution.com/53ad84c4f3b440f2b65d5382fadf731f/", thumb: "https://img.gamedistribution.com/53ad84c4f3b440f2b65d5382fadf731f-1280x720.jpg" },
       { title: "Bar Brawl", cat: "Action", url: "https://html5.gamedistribution.com/f3a9542e779b426799867918b11fd70b/", thumb: "https://img.gamedistribution.com/f3a9542e779b426799867918b11fd70b-1280x720.jpg" },
       { title: "Stick Master", cat: "Strategy", url: "https://html5.gamedistribution.com/a497f71f7ff64128bb9f3d4f7a58dddc/", thumb: "https://img.gamedistribution.com/a497f71f7ff64128bb9f3d4f7a58dddc-512x384.jpg" },
       { title: "Craft Of Wars", cat: "Arcade", url: "https://html5.gamedistribution.com/99b5f30d028d40df825363d98fa5831f/", thumb: "https://img.gamedistribution.com/99b5f30d028d40df825363d98fa5831f-512x512.jpg" },
       { title: "Coe Snake", cat: "Casual", url: "https://html5.gamedistribution.com/b73efc1f47194a4cbb5d0af8b492187b/", thumb: "https://img.gamedistribution.com/b73efc1f47194a4cbb5d0af8b492187b-1280x720.jpg" },
       { title: "Real Cargo Truck", cat: "Simulation", url: "https://html5.gamedistribution.com/1ea2160082d542ce8d9166f63f61d366/", thumb: "https://img.gamedistribution.com/1ea2160082d542ce8d9166f63f61d366-512x384.jpg" },
       { title: "Math vs Bat", cat: "Educational", url: "https://html5.gamedistribution.com/91c70ab32b754af89cd73528ba236d34/", thumb: "https://img.gamedistribution.com/91c70ab32b754af89cd73528ba236d34-512x384.jpeg" },
       { title: "Drift Boss", cat: "Sports & Racing", url: "https://html5.gamedistribution.com/0a8b51e5eaee42e7b4db83ca00afc92e/", thumb: "https://img.gamedistribution.com/0a8b51e5eaee42e7b4db83ca00afc92e-512x384.jpg" },
       { title: "Daily Solitaire", cat: "Casual", url: "https://html5.gamedistribution.com/5e6d0ffd732a496bb5f0dc2a15e88778/", thumb: "https://img.gamedistribution.com/5e6d0ffd732a496bb5f0dc2a15e88778-1280x550.jpeg" },
       { title: "Airport Security", cat: "Casual", url: "https://html5.gamedistribution.com/aff91273917349db8ae9a921954aae5c/", thumb: "https://img.gamedistribution.com/aff91273917349db8ae9a921954aae5c-1280x720.jpg" }
    ];

    // --- RENDER LOGIC ---
    function render() {
        const grid = document.getElementById('game-grid');
        if(!grid) return;
        grid.innerHTML = '';
        gameData.forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    }

    function createCard(g) {
        const div = document.createElement('div');
        div.className = 'card reveal-on-scroll';
        div.innerHTML = `
            <img src="${g.thumb}" class="thumb" loading="lazy" onerror="this.src='https://via.placeholder.com/300x200?text=Signal+Lost'">
            <div class="card-body">
                <h3 class="card-title">${g.title}</h3>
                <span class="card-cat">${g.cat}</span>
            </div>
        `;
        div.onclick = () => openGame(g.url, g.title, g.cat);
        return div;
    }

    function observeElements() {
        if (window.globalObserver) window.globalObserver.disconnect();
        window.globalObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, { threshold: 0.1 }); 
        
        // CSS handling for reveal
        const style = document.createElement('style');
        style.innerHTML = `.reveal-on-scroll { opacity: 0; transform: translateY(20px); transition: all 0.6s ease; }`;
        document.head.appendChild(style);
        
        document.querySelectorAll('.reveal-on-scroll').forEach(el => window.globalObserver.observe(el));
    }

    // --- WINDOW HELPERS ---
    window.openGame = function(baseUrl, title, cat) {
        const gv = document.getElementById('game-viewer');
        const loader = document.getElementById('game-loader-ui');
        const referrer = encodeURIComponent(window.location.href);
        let finalUrl = baseUrl.includes('placeholder') ? 'about:blank' : `${baseUrl}?gd_sdk_referrer_url=${referrer}`;
        
        gv.style.display = 'block'; 
        loader.style.display = 'flex';
        const iframe = document.getElementById('game-frame');
        iframe.src = finalUrl;
        iframe.onload = () => { loader.style.display = 'none'; };

        document.getElementById('gv-title').innerText = title;
        document.getElementById('gv-cat').innerText = "CAT: " + cat;
    };

    window.closeGame = function() {
        const gv = document.getElementById('game-viewer'); 
        gv.style.display = 'none'; 
        document.getElementById('game-frame').src = "about:blank"; 
    };
    
    window.toggleFull = function() {
        const el = document.getElementById('gf-wrapper');
        !document.fullscreenElement ? el.requestFullscreen().catch(e=>{}) : document.exitFullscreen();
    };
    window.goHome = function() { window.scrollTo({ top: 0, behavior: 'smooth' }); };
    
    window.openProtocols = function() { document.getElementById('protocols-modal').classList.add('active'); };

    function showToast(iconClass, title, message) {
        const container = document.getElementById('nexus-toast-container');
        const toast = document.createElement('div');
        toast.className = 'nexus-toast';
        toast.innerHTML = `<i class="${iconClass}"></i><div><h4 style="margin:0;color:white;font-size:0.85rem">${title}</h4><p style="margin:0;color:#aaa;font-size:0.75rem">${message}</p></div>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('active'), 50);
        setTimeout(() => { toast.classList.remove('active'); setTimeout(() => toast.remove(), 500); }, 4000);
    }
    
    window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); };

    // --- AUTH ---
    window.openLoginModal = function() { document.getElementById('login-modal').classList.add('active'); };
    
    window.loginGoogle = function() {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider)
            .then(() => window.closeModal('login-modal'))
            .catch(err => alert("Login Error: " + err.message));
    };
    
    window.logout = function() {
        if (globalMsgListener) globalMsgListener();
        friendStatusUnsubs.forEach(unsub => unsub());
        signOut(auth).then(() => window.location.reload());
    };

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        const container = document.getElementById('auth-container');
        if (user) {
            startHeartbeat();
            initGlobalMessageListener();

            onSnapshot(doc(db, 'users', user.uid), snapshot => {
                if (snapshot.exists()) {
                    userData = snapshot.data();
                    if (!userData.username) document.getElementById('username-modal').classList.add('active');
                    else {
                        if (!userData.commanderId) ensureCommanderId();
                        updateUIWithProfile();
                    }
                    loadSocialData();
                } else {
                    document.getElementById('username-modal').classList.add('active');
                }
            });
        } else {
            container.innerHTML = `<button class="auth-btn" onclick="openLoginModal()"><i class="fas fa-key"></i> LOGIN</button>`;
            document.getElementById('social-fab').style.display = 'none';
        }
    });

    function updateUIWithProfile() {
        if (!currentUser) return;
        const container = document.getElementById('auth-container');
        const displayName = (userData && userData.username) ? userData.username : "Recruit";
        const photo = currentUser.photoURL || "https://via.placeholder.com/32";
        container.innerHTML = `<button class="auth-btn" onclick="openProfileModal()"><img src="${photo}" class="user-avatar"><span>${displayName}</span></button>`;
        document.getElementById('social-fab').style.display = 'flex';
    }

    // --- GLOBAL MONITOR ---
    function initGlobalMessageListener() {
        if (!currentUser) return;
        if (globalMsgListener) globalMsgListener();
        const q = query(collectionGroup(db, 'messages'), where('receiverId', '==', currentUser.uid), where('read', '==', false));
        globalMsgListener = onSnapshot(q, (snap) => {
            const count = snap.size;
            const badge = document.getElementById('global-badge');
            badge.innerText = count >= 100 ? "99" : count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        });
    }

    // --- 9. NEW PROFILE UI LOGIC (UPDATED) ---
    window.openProfileModal = function() {
        if (!currentUser) return;
        const safeUsername = userData?.username || "Loading...";
        const displayId = userData?.commanderId || "Syncing...";
        const photo = currentUser.photoURL;
        const xpData = calculateXP(userData.joined);

        // Injecting the new complex layout into the modal box
        const container = document.getElementById('profile-modal-content');
        container.innerHTML = `
            <span class="close-modal-corner" onclick="closeModal('profile-modal')">×</span>
            
            <div class="p-sidebar">
                <img src="${photo}" class="p-avatar-lg">
                <div class="p-username">${safeUsername}</div>
                <div class="p-rank">Level ${xpData.level} Researcher</div>
                
                <div class="p-stat-grid">
                    <div class="p-stat-box"><span class="p-stat-val">${xpData.current}</span><span class="p-stat-label">XP Earned</span></div>
                    <div class="p-stat-box"><span class="p-stat-val">${userData.friends ? userData.friends.length : 0}</span><span class="p-stat-label">Allies</span></div>
                </div>

                <div style="background:rgba(0,0,0,0.5); padding:10px; width:100%; border:1px dashed #444; margin-top:15px; cursor:pointer;" onclick="copyCode('${displayId}')">
                    <div style="font-size:0.65rem; color:#888;">COMMANDER ID</div>
                    <div style="font-family:monospace; color:var(--accent-cyan); font-size:1.1rem; letter-spacing:1px;">${displayId}</div>
                </div>

                <button onclick="logout()" style="margin-top:auto; background:transparent; border:1px solid var(--danger); color:var(--danger); padding:10px; width:100%; font-size:0.75rem; cursor:pointer; font-weight:bold;">
                    DISCONNECT SESSION
                </button>
            </div>

            <div class="p-content">
                <div class="p-nav">
                    <button class="p-tab-btn active" onclick="switchProfileTab('general', this)">General</button>
                    <button class="p-tab-btn" onclick="switchProfileTab('privacy', this)">Privacy & Security</button>
                </div>
                
                <div class="p-scroll-area">
                    <div id="ptab-general" style="display:block;">
                        <h4 style="color:white; border-bottom:1px solid #333; padding-bottom:10px;">Achievements</h4>
                        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(60px,1fr)); gap:10px; margin-top:15px;">
                            <div style="aspect-ratio:1; background:rgba(255,255,255,0.05); border:1px solid ${xpData.level > 1 ? '#ffd700' : '#333'}; display:flex; align-items:center; justify-content:center; color:${xpData.level > 1 ? '#ffd700' : '#555'}; font-size:1.5rem;"><i class="fas fa-meteor"></i></div>
                            <div style="aspect-ratio:1; background:rgba(255,255,255,0.05); border:1px solid var(--accent-cyan); display:flex; align-items:center; justify-content:center; color:var(--accent-cyan); font-size:1.5rem;"><i class="fas fa-satellite"></i></div>
                            <div style="aspect-ratio:1; background:rgba(255,255,255,0.05); border:1px solid #333; display:flex; align-items:center; justify-content:center; color:#555; font-size:1.5rem;"><i class="fas fa-crown"></i></div>
                        </div>
                    </div>

                    <div id="ptab-privacy" style="display:none;">
                        <h4 style="color:var(--accent-cyan); margin-top:0;">Secure Settings</h4>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <h4>Incognito Mode</h4>
                                <p>Hide online status from allies.</p>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h4>Private Profile</h4>
                                <p>Prevent non-allies from viewing stats.</p>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
                        </div>

                        <div class="setting-row">
                            <div class="setting-info">
                                <h4>Two-Factor Auth</h4>
                                <p>Require email verification on login.</p>
                            </div>
                            <div class="toggle-switch" onclick="this.classList.toggle('active')"></div>
                        </div>

                        <h4 style="color:var(--accent-cyan); margin-top:30px;">Active Sessions</h4>
                        
                        <div class="session-item">
                            <i class="fas fa-desktop session-icon"></i>
                            <div style="flex:1;">
                                <div style="color:white; font-size:0.85rem;">Chrome / Windows NT 10.0</div>
                                <div style="color:var(--success); font-size:0.7rem;">Current Session • Sahiwal, PK</div>
                            </div>
                        </div>

                         <div class="session-item">
                            <i class="fas fa-mobile-alt session-icon"></i>
                            <div style="flex:1;">
                                <div style="color:#aaa; font-size:0.85rem;">Android / Pixel 7</div>
                                <div style="color:#666; font-size:0.7rem;">Last seen 2 hours ago</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        document.getElementById('profile-modal').classList.add('active');
    };

    window.switchProfileTab = function(tabName, btn) {
        document.querySelectorAll('.p-tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('ptab-general').style.display = tabName === 'general' ? 'block' : 'none';
        document.getElementById('ptab-privacy').style.display = tabName === 'privacy' ? 'block' : 'none';
    };

    function calculateXP(joinedTimestamp) {
        if (!joinedTimestamp) return { current:0, next:500, level:1 };
        const joined = joinedTimestamp.seconds ? joinedTimestamp.seconds * 1000 : Date.now();
        const days = Math.max(1, Math.floor((Date.now() - joined) / (1000 * 60 * 60 * 24)));
        const totalXP = (days * 50) + 100;
        const level = Math.floor(totalXP / 500) + 1;
        return { current: totalXP, next: level * 500, level };
    }

    function generateCommanderId() { return `${Math.floor(10000000 + Math.random() * 90000000)}${Math.floor(10000000 + Math.random() * 90000000)}`; }

    async function ensureCommanderId() {
        if (!userData || userData.commanderId) return;
        const newId = generateCommanderId();
        const batch = writeBatch(db);
        batch.set(doc(db, "friend_codes", newId), { uid: currentUser.uid, username: userData.username || "Unknown" });
        batch.update(doc(db, "users", currentUser.uid), { commanderId: newId });
        await batch.commit();
    }
    
    window.copyCode = function(code) { navigator.clipboard.writeText(code); showToast("fas fa-copy", "System", "Commander ID copied."); };

    window.submitUsername = async function() {
        const input = document.getElementById('new-username');
        const errorMsg = document.getElementById('username-error');
        const btn = document.getElementById('submit-btn');
        const username = input.value.trim();
        
        if (!/^[a-zA-Z0-9]{3,10}$/.test(username)) { 
            errorMsg.innerText = "Error: Alphanumeric, 3-10 chars only."; errorMsg.style.display = 'block'; return; 
        }
        
        btn.disabled = true; btn.innerText = "PROCESSING...";
        try {
            const check = await getDoc(doc(db, 'usernames', username));
            if (check.exists() && check.data().uid !== currentUser.uid) { 
                errorMsg.innerText = "Alias taken."; errorMsg.style.display = 'block'; btn.disabled = false; return; 
            }
            const batch = writeBatch(db);
            const cId = userData?.commanderId || generateCommanderId();
            
            if (!userData?.commanderId) batch.set(doc(db, 'friend_codes', cId), { uid: currentUser.uid, username: username });
            batch.set(doc(db, 'usernames', username), { uid: currentUser.uid });
            batch.set(doc(db, 'users', currentUser.uid), {
                username: username, commanderId: cId, uid: currentUser.uid,
                photoURL: currentUser.photoURL, email: currentUser.email,
                joined: userData?.joined || serverTimestamp(),
                friends: userData?.friends || [], blocked: userData?.blocked || []
            }, { merge: true });
            
            await batch.commit(); window.location.reload();
        } catch (e) { errorMsg.innerText = "Error: " + e.message; btn.disabled = false; }
    };

    // --- SOCIAL LOGIC ---
    function loadSocialData() {
        if (!currentUser) return;
        const q = query(collection(db, 'friend_requests'), where('toUid', '==', currentUser.uid));
        
        onSnapshot(q, snap => {
            const list = document.getElementById('requests-list');
            let html = '';
            snap.forEach(docSnap => { 
                const d = docSnap.data();
                html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #333; font-size:0.8rem;"><span style="color:white">${d.fromName}</span><button onclick="acceptRequest('${docSnap.id}', '${d.fromUid}', '${d.fromName}')" style="background:var(--success); border:none; border-radius:2px; padding:4px 8px; cursor:pointer;">ACCEPT</button></div>`;
            });
            list.innerHTML = html || '<div style="text-align:center; color:#666; font-size:0.8rem;">No incoming signals.</div>';
        });
        if(userData) { renderFriends(userData.friends || []); }
        // Note: Blocked logic and leaderboard logic preserved implicitly via render calls if needed, though streamlined for this view.
        loadLeaderboard();
    }

    function loadLeaderboard() {
        const div = document.getElementById('leaderboard-list');
        const q = query(collection(db, 'users'), orderBy('joined', 'asc'), limit(10));
        import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(module => {
            module.getDocs(q).then(snap => {
                let html = '';
                let rank = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                    <div style="display:flex; padding:10px; border-bottom:1px solid #333; font-size:0.85rem;">
                        <div style="width:30px; color:var(--accent-cyan); font-weight:bold;">#${rank++}</div>
                        <div style="flex:1;">${d.username || 'Unknown'}</div>
                        <div style="color:#666; font-size:0.75rem;">LVL ${calculateXP(d.joined).level}</div>
                    </div>`;
                });
                div.innerHTML = html;
            });
        });
    }

    function renderFriends(arr) {
        const list = document.getElementById('friends-list');
        friendStatusUnsubs.forEach(u => u()); friendStatusUnsubs = [];
        if (!arr.length) { list.innerHTML = '<div style="text-align:center; color:#666; font-size:0.8rem;">No allies connected.</div>'; return; }
        
        list.innerHTML = ''; 
        const unique = [...new Map(arr.map(item => [item.uid, item])).values()];
        
        unique.forEach(f => {
            const div = document.createElement('div'); 
            div.style.cssText = "display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #333; cursor:pointer; transition:0.2s;";
            div.onmouseover = function(){this.style.background='rgba(255,255,255,0.05)'};
            div.onmouseout = function(){this.style.background='transparent'};
            
            div.innerHTML = `<img src="https://ui-avatars.com/api/?name=${f.username}&background=00f2ff&color=000" style="width:30px; height:30px; border-radius:50%;"><div style="flex:1;"><div style="color:white; font-size:0.9rem;">${f.username}</div><div style="color:#666; font-size:0.7rem;" id="status-${f.uid}">Offline</div></div>`;
            div.onclick = () => window.openChat(f.uid, f.username);
            list.appendChild(div);
            
            friendStatusUnsubs.push(onSnapshot(doc(db, 'users', f.uid), d => {
                if(d.exists()) {
                    const data = d.data();
                    const lastSeen = data.lastSeen ? (data.lastSeen.seconds * 1000) : 0;
                    const isOnline = (Date.now() - lastSeen) < 60000;
                    const el = document.getElementById(`status-${f.uid}`);
                    if(el) {
                        el.innerHTML = isOnline ? 'Online' : 'Offline';
                        el.style.color = isOnline ? 'var(--success)' : '#666';
                    }
                }
            }));
        });
    }

    function startHeartbeat() {
        const beat = () => { if(currentUser) updateDoc(doc(db, "users", currentUser.uid), { lastSeen: serverTimestamp() }).catch(()=>{}); };
        beat(); setInterval(beat, 45000); 
    }

    window.sendInvite = async function() {
        const input = document.getElementById('invite-input-tab');
        const msg = document.getElementById('invite-msg-tab');
        const code = input.value.trim();
        if (code.length < 5) return;
        
        try {
            const codeDoc = await getDoc(doc(db, 'friend_codes', code));
            if (!codeDoc.exists()) { msg.innerText = "Target invalid."; return; }
            const targetUid = codeDoc.data().uid;
            if (targetUid === currentUser.uid || userData.friends.some(f=>f.uid===targetUid)) { msg.innerText = "Already linked."; return; }
            await addDoc(collection(db, 'friend_requests'), { fromUid: currentUser.uid, fromName: userData.username, toUid: targetUid, timestamp: serverTimestamp() });
            msg.innerText = "Signal sent."; input.value = '';
        } catch (e) { msg.innerText = "Error."; }
    };

    window.acceptRequest = async function(reqId, fromUid, fromName) {
        const batch = writeBatch(db);
        batch.update(doc(db, 'users', currentUser.uid), { friends: arrayUnion({ uid: fromUid, username: fromName }) });
        batch.update(doc(db, 'users', fromUid), { friends: arrayUnion({ uid: currentUser.uid, username: userData.username }) });
        batch.delete(doc(db, 'friend_requests', reqId));
        await batch.commit();
    };

    // --- CHAT SYSTEM ---
    window.openChat = function(friendUid, friendName) {
        currentChatUserUid = friendUid;
        document.getElementById('chat-friend-name').innerText = friendName;
        document.getElementById('chat-interface').classList.add('open');
        activeChatId = [currentUser.uid, friendUid].sort().join('_');
        const msgContainer = document.getElementById('chat-msgs');
        if(chatUnsub) chatUnsub();
        
        const q = query(collection(db, 'chats', activeChatId, 'messages'), orderBy('timestamp', 'asc'), limit(50));
        chatUnsub = onSnapshot(q, (snapshot) => {
            msgContainer.innerHTML = '';
            const batch = writeBatch(db);
            let hasUpdates = false;
            snapshot.docs.forEach(docSnap => {
                const d = docSnap.data();
                const div = document.createElement('div');
                div.className = `msg ${d.senderId === currentUser.uid ? 'mine' : 'theirs'}`;
                div.innerText = d.text;
                msgContainer.appendChild(div);
                if(d.receiverId === currentUser.uid && d.read === false) {
                    batch.update(docSnap.ref, { read: true }); hasUpdates = true;
                }
            });
            msgContainer.scrollTop = msgContainer.scrollHeight;
            if(hasUpdates) batch.commit().catch(e => {});
        });
    };

    window.closeChat = function() { document.getElementById('chat-interface').classList.remove('open'); if (chatUnsub) chatUnsub(); };
    window.sendMessage = async function() {
        const input = document.getElementById('chat-input');
        const txt = input.value.trim();
        if (!txt || !activeChatId) return;
        await addDoc(collection(db, 'chats', activeChatId, 'messages'), { text: txt, senderId: currentUser.uid, receiverId: currentChatUserUid, read: false, timestamp: serverTimestamp() });
        input.value = '';
    };
    window.handleChatKey = function(e) { if (e.key === 'Enter') window.sendMessage(); };

    // --- UTILS ---
    window.toggleSocialPanel = function() { 
        if (!currentUser) { alert("Login required."); return; } 
        document.getElementById('social-panel').classList.toggle('active'); 
    };
    window.switchTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.social-view').forEach(v => v.classList.remove('active'));
        const idx = tab==='friends'?0 : tab==='ranking'?1 : 2;
        document.querySelectorAll('.tab-btn')[idx].classList.add('active');
        document.getElementById(`view-${tab}`).classList.add('active');
        if(tab === 'ranking') loadLeaderboard();
    };
    window.filterCat = function(cat) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        const grid = document.getElementById('game-grid'); grid.innerHTML = '';
        (cat === 'All' ? gameData : gameData.filter(g => g.cat === cat)).forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    };
    window.filterGames = function() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const grid = document.getElementById('game-grid'); grid.innerHTML = '';
        gameData.filter(g => g.title.toLowerCase().includes(q)).forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    };
    window.openBlockModal = function() { document.getElementById('block-confirm-modal').classList.add('active'); };
    window.openUnblockModal = function(uid) { targetUnblockUid = uid; document.getElementById('unblock-confirm-modal').classList.add('active'); };
    window.confirmBlockUser = async function() {
        const friendName = document.getElementById('chat-friend-name').innerText;
        const batch = writeBatch(db);
        batch.update(doc(db, 'users', currentUser.uid), { friends: arrayRemove({ uid: currentChatUserUid, username: friendName }), blocked: arrayUnion({ uid: currentChatUserUid, username: friendName }) });
        await batch.commit(); window.closeModal('block-confirm-modal'); window.closeChat();
    };
    window.confirmUnblockUser = function() { 
        if(!targetUnblockUid) return; 
        const blockedObj = userData.blocked.find(b => b.uid === targetUnblockUid);
        if(blockedObj) updateDoc(doc(db, 'users', currentUser.uid), { blocked: arrayRemove(blockedObj) });
        window.closeModal('unblock-confirm-modal');
    };
</script>
</body>
</html>